<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=900">
	<title>engine objects</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<!--<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>-->
	<!-- custom -->
	<style>
		table {width: 880px;}
		#tb3 td:first-child { text-align: left; vertical-align: top;}
		hr {color: #dcc18c}
	</style>
</head>
<body>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb3">
		<col width="50%"><col width="50%">
		<thead><tr><th colspan="2">
			<div class="nav-title">engine objects
				<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="mono" style="text-align: left; vertical-align: top;">
			<span class="btn3 btnfirst" onClick="rerun()">[ run ]</span>
			<span class="btn3 btn" onClick="scrape()">[ scrape ]</span>
			<span class="btn3 btn" onClick="copyclip(`results`)">[ copy ]</span>
			<br><br>
			<hr>
			<br>
			<span class="spaces" style="color: #b3b3b3;" id="results"></span>
			</td>
		</tr>
	</table>
	<br>

<script>
'use strict';

let oTypes = {},
	aList = [],
	tstart,
	domresult = document.getElementById("results"),
	domperf = document.getElementById("perf"),
	s3 = "<span class='s3'>",
	sc = "</span>"

/** functions from generic **/
// we don't want to include globals or generic which will pollute scraping

function mini(str) {
	// https://stackoverflow.com/a/22429679
	const json = `${JSON.stringify(str)}`
	let i, len, hash = 0x811c9dc5
	for (i = 0, len = json.length; i < len; i++) {
		hash = Math.imul(31, hash) + json.charCodeAt(i) | 0
	}
	return ('0000000' + (hash >>> 0).toString(16)).slice(-8)
}

function mini_sha1(str) {
	return sha1(mini(str))
}

function sha1(str1){
	for (var blockstart=0,
		i = 0,
		W = [],
		H = [0x67452301, 0xEFCDAB89, 0x98BADCFE, 0x10325476, 0xC3D2E1F0],
		A, B, C, D, F, G,
		word_array = [],
		temp2,
		s = unescape(encodeURI(str1)),
		str_len = s.length;
		i<=str_len;){
		word_array[i>>2] |= (s.charCodeAt(i)||128)<<(8*(3-i++%4));
	}
	word_array[temp2 = ((str_len+8)>>6<<4)+15] = str_len<<3;
	for (; blockstart <= temp2; blockstart += 16) {
		A = H,i=0;
		for (; i < 80;
			A = [[
				(G = ((s=A[0])<<5|s>>>27) + A[4] + (W[i] = (i<16) ? ~~word_array[blockstart + i] : G<<1|G>>>31) + 1518500249) + ((B=A[1]) & (C=A[2]) | ~B & (D=A[3])),
				F = G + (B ^ C ^ D) + 341275144,
				G + (B & C | B & D | C & D) + 882459459,
				F + 1535694389
			][0|i++/20] | 0, s, B<<30|B>>>2, C, D]
		) {
			G = W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16];
		}
		for(i=5;i;) H[--i] = H[i] + A[i] | 0;
	}
	for(str1='';i<40;)str1 += (H[i>>3] >> (7-i++%8)*4 & 15).toString(16);
	return str1
}

function copyclip(element) {
	// fallback: e.g FF62-
	function copyExec() {
		if (document.selection) {
			let range = document.body.createTextRange()
			range.moveToElementText(document.getElementById(element))
			range.select().createTextRange()
			document.execCommand("copy")
		} else if (window.getSelection) {
			let range = document.createRange()
			range.selectNode(document.getElementById(element))
			window.getSelection().addRange(range)
			document.execCommand("copy")
		}
	}
	// clipboard API
	if ("clipboard" in navigator) {
		try {
			let content = document.getElementById(element).innerHTML
			// remove spans, change linebreaks
			let regex = /<br\s*[\/]?>/gi
			content = content.replace(regex, "\r\n")
			content = content.replace(/<\/?span[^>]*>/g,"")
			// get it
			navigator.clipboard.writeText(content).then(function() {
				// clipboard successfully set
			}, function() {
				// clipboard write failed
				copyExec()
			})
		} catch(e) {
			copyExec()
		}
	} else {
		copyExec()
	}
}

/** function for this test **/

function collectProps () {
    const objCache = new Set();
    // skip these
    objCache.add(window.self);
    // prevent us decending into the DOM
    objCache.add(document);
    objCache.add(document.activeElement);
    objCache.add(event?.currentTarget);
    const recursionAllowed = new Set();
    recursionAllowed.add('navigator');

    function extractObjectProps (obj, breadcrumbs = [], depth = 0) {
        if (depth >= 5) {
            return {};
        }
        const props = {};
        const proplist = [];
        for (const prop in obj) {
            proplist.push(prop);
        }
        proplist.sort().forEach((prop) => {
            try {
                const desc = Object.getOwnPropertyDescriptor(obj, prop) || {};
                desc.type = typeof obj[prop];
                if (desc.type === 'function') {
                    desc.value = obj[prop].toString();
                } else if (desc.type === 'object') {
                    if (!objCache.has(obj[prop]) || recursionAllowed.has(prop)) {
                        objCache.add(obj[prop]);
                        desc.properties = extractObjectProps(obj[prop], [...breadcrumbs, prop], depth + 1);
                    }
                    delete desc.value;
                }
                props[prop] = desc;
            } catch (e) {
                console.warn(`Error for ${breadcrumbs.join('.')}.${prop}`, e);
            }
        });
        return props;
    }

    return {
        window: extractObjectProps(window)
    }
}

function logList() {
	console.log(aList.join(", "))
}

function output() {
	aList.sort()
	domperf.innerHTML = Math.round((performance.now() - tstart)) +" ms | "
		+ "<span style='cursor: pointer;' onClick='logList()'>" + aList.length +" items" +"</span>"
	let display = []
	for (const k of Object.keys(oTypes).sort()) {
		let res = oTypes[k]
		res.sort()
		if (res.length) {
			let type = k.toUpperCase().padEnd(9)
			let hash = mini_sha1(res.join())
			display.push(s3 + type + sc +": "+ hash + s3 +" ["+ res.length +"]"+ sc +"<br>")
			display.push("'"+ res.join("', '") + "'<br>")
		}
		domresult.innerHTML = display.join("<br>")
	}
}

function rec(type, name) {
	aList.push(name)
	oTypes[type].push(name)
}

function reset() {
	oTypes = {
		"undefined" : [],
		"boolean": [],
		"number": [],
		"bigint": [],
		"string": [],
		"symbol": [],
		"function": [],
		"object": [],
	}
	aList = []
	domresult.innerHTML = ""
}

function rerun() {
	reset()
	// delay so user sees changes
	setTimeout(function() {
		run()
	}, 170)
}

function run() {
	try {
		tstart = performance.now()
// gecko functions have line endings: e.g.
// gecko: value": "function atob() {\n    [native code]\n}"
// blink: value": "function atob() { [native code] }",

// blink not gecko
rec(typeof PERSISTENT, "PERSISTENT")
rec(typeof TEMPORARY, "TEMPORARY")
rec(typeof defaultStatus, "defaultStatus")
rec(typeof defaultstatus, "defaultstatus")
rec(typeof getScreenDetails, "getScreenDetails")
rec(typeof launchQueue, "launchQueue")
rec(typeof onbeforexrselect, "onbeforexrselect")
rec(typeof oncancel, "oncancel")
rec(typeof oncontextlost, "oncontextlost")
rec(typeof oncontextrestored, "oncontextrestored")
rec(typeof ondeviceorientationabsolute, "ondeviceorientationabsolute")
rec(typeof onmousewheel, "onmousewheel")
rec(typeof onpointerrawupdate, "onpointerrawupdate")
rec(typeof onsearch, "onsearch")
rec(typeof openDatabase, "openDatabase")
rec(typeof originAgentCluster, "originAgentCluster")
rec(typeof queryLocalFonts, "queryLocalFonts")
rec(typeof showDirectoryPicker, "showDirectoryPicker")
rec(typeof showOpenFilePicker, "showOpenFilePicker")
rec(typeof showSaveFilePicker, "showSaveFilePicker")
rec(typeof webkitCancelAnimationFrame, "webkitCancelAnimationFrame")
rec(typeof webkitRequestAnimationFrame, "webkitRequestAnimationFrame")
rec(typeof webkitRequestFileSystem, "webkitRequestFileSystem")
rec(typeof webkitResolveLocalFileSystemURL, "webkitResolveLocalFileSystemURL")

//
rec(typeof addEventListener, "addEventListener")
rec(typeof alert, "alert")
rec(typeof atob, "atob")

rec(typeof blur, "blur")
rec(typeof btoa, "btoa")

rec(typeof cancelAnimationFrame, "cancelAnimationFrame")
rec(typeof cancelIdleCallback, "cancelIdleCallback")
rec(typeof captureEvents, "captureEvents")
rec(typeof clearInterval, "clearInterval")
rec(typeof clearTimeout, "clearTimeout")
rec(typeof close, "close")
rec(typeof closed, "closed")
rec(typeof confirm, "confirm")
rec(typeof createImageBitmap, "createImageBitmap")
rec(typeof crossOriginIsolated, "crossOriginIsolated")

rec(typeof devicePixelRatio, "devicePixelRatio")
rec(typeof dispatchEvent, "dispatchEvent")
rec(typeof document, "document")
rec(typeof dump, "dump")

rec(typeof event, "event")

rec(typeof fetch, "fetch")
rec(typeof find, "find")
rec(typeof focus, "focus")
rec(typeof frameElement, "frameElement")
rec(typeof frames, "frames")
rec(typeof fullScreen, "fullScreen")

rec(typeof getComputedStyle, "getComputedStyle")
rec(typeof getDefaultComputedStyle, "getDefaultComputedStyle")
rec(typeof getSelection, "getSelection")

rec(typeof innerHeight, "innerHeight")
rec(typeof innerWidth, "innerWidth")
rec(typeof isSecureContext, "isSecureContext")

rec(typeof keys, "keys")
rec(typeof Keyboard, "Keyboard")
rec(typeof KeyboardEvent, "KeyboardEvent")
rec(typeof KeyboardLayoutMap, "KeyboardLayoutMap")
rec(typeof KeyEvent, "KeyEvent")
rec(typeof KeyframeEffect, "KeyframeEffect")

rec(typeof length, "length")

rec(typeof matchMedia, "matchMedia")
rec(typeof moveBy, "moveBy")
rec(typeof moveTo, "moveTo")
rec(typeof mozInnerScreenX, "mozInnerScreenX")
rec(typeof mozInnerScreenY, "mozInnerScreenY")

rec(typeof name, "name")

rec(typeof onabort, "onabort")
rec(typeof onabsolutedeviceorientation, "onabsolutedeviceorientation")
rec(typeof onafterprint, "onafterprint")
rec(typeof onanimationcancel, "onanimationcancel")
rec(typeof onanimationend, "onanimationend")
rec(typeof onanimationiteration, "onanimationiteration")
rec(typeof onanimationstart, "onanimationstart")
rec(typeof onauxclick, "onauxclick")
rec(typeof onbeforeinput, "onbeforeinput")
rec(typeof onbeforeprint, "onbeforeprint")
rec(typeof onbeforeunload, "onbeforeunload")
rec(typeof onblur, "onblur")
rec(typeof oncanplay, "oncanplay")
rec(typeof oncanplaythrough, "oncanplaythrough")
rec(typeof onchange, "onchange")
rec(typeof onclick, "onclick")
rec(typeof onclose, "onclose")
rec(typeof oncontextmenu, "oncontextmenu")
rec(typeof oncuechange, "oncuechange")
rec(typeof ondblclick, "ondblclick")
rec(typeof ondevicemotion, "ondevicemotion")
rec(typeof ondeviceorientation, "ondeviceorientation")
rec(typeof ondrag, "ondrag")
rec(typeof ondragend, "ondragend")
rec(typeof ondragenter, "ondragenter")
rec(typeof ondragleave, "ondragleave")
rec(typeof ondragover, "ondragover")
rec(typeof ondragstart, "ondragstart")
rec(typeof ondrop, "ondrop")
rec(typeof ondurationchange, "ondurationchange")
rec(typeof onemptied, "onemptied")
rec(typeof onended, "onended")
rec(typeof onerror, "onerror")
rec(typeof onfocus, "onfocus")
rec(typeof onformdata, "onformdata")
rec(typeof ongamepadconnected, "ongamepadconnected")
rec(typeof ongamepaddisconnected, "ongamepaddisconnected")
rec(typeof ongotpointercapture, "ongotpointercapture")
rec(typeof onhashchange, "onhashchange")
rec(typeof oninput, "oninput")
rec(typeof oninvalid, "oninvalid")
rec(typeof onkeydown, "onkeydown")
rec(typeof onkeypress, "onkeypress")
rec(typeof onkeyup, "onkeyup")
rec(typeof onlanguagechange, "onlanguagechange")
rec(typeof onload, "onload")
rec(typeof onloadeddata, "onloadeddata")
rec(typeof onloadedmetadata, "onloadedmetadata")
rec(typeof onloadend, "onloadend")
rec(typeof onloadstart, "onloadstart")
rec(typeof onlostpointercapture, "onlostpointercapture")
rec(typeof onmessage, "onmessage")
rec(typeof onmessageerror, "onmessageerror")
rec(typeof onmousedown, "onmousedown")
rec(typeof onmouseenter, "onmouseenter")
rec(typeof onmouseleave, "onmouseleave")
rec(typeof onmousemove, "onmousemove")
rec(typeof onmouseout, "onmouseout")
rec(typeof onmouseover, "onmouseover")
rec(typeof onmouseup, "onmouseup")
rec(typeof onmozfullscreenchange, "onmozfullscreenchange")
rec(typeof onmozfullscreenerror, "onmozfullscreenerror")
rec(typeof onoffline, "onoffline")
rec(typeof ononline, "ononline")
rec(typeof onpagehide, "onpagehide")
rec(typeof onpageshow, "onpageshow")
rec(typeof onpause, "onpause")
rec(typeof onplay, "onplay")
rec(typeof onplaying, "onplaying")
rec(typeof onpointercancel, "onpointercancel")
rec(typeof onpointerdown, "onpointerdown")
rec(typeof onpointerenter, "onpointerenter")
rec(typeof onpointerleave, "onpointerleave")
rec(typeof onpointermove, "onpointermove")
rec(typeof onpointerout, "onpointerout")
rec(typeof onpointerover, "onpointerover")
rec(typeof onpointerup, "onpointerup")
rec(typeof onpopstate, "onpopstate")
rec(typeof onprogress, "onprogress")
rec(typeof onratechange, "onratechange")
rec(typeof onrejectionhandled, "onrejectionhandled")
rec(typeof onreset, "onreset")
rec(typeof onresize, "onresize")
rec(typeof onscroll, "onscroll")
rec(typeof onsecuritypolicyviolation, "onsecuritypolicyviolation")
rec(typeof onseeked, "onseeked")
rec(typeof onseeking, "onseeking")
rec(typeof onselect, "onselect")
rec(typeof onselectionchange, "onselectionchange")
rec(typeof onselectstart, "onselectstart")
rec(typeof onslotchange, "onslotchange")
rec(typeof onstalled, "onstalled")
rec(typeof onstorage, "onstorage")
rec(typeof onsubmit, "onsubmit")
rec(typeof onsuspend, "onsuspend")
rec(typeof ontimeupdate, "ontimeupdate")
rec(typeof ontoggle, "ontoggle")
rec(typeof ontransitioncancel, "ontransitioncancel")
rec(typeof ontransitionend, "ontransitionend")
rec(typeof ontransitionrun, "ontransitionrun")
rec(typeof ontransitionstart, "ontransitionstart")
rec(typeof onunhandledrejection, "onunhandledrejection")
rec(typeof onunload, "onunload")
rec(typeof onvolumechange, "onvolumechange")
rec(typeof onvrdisplayactivate, "onvrdisplayactivate")
rec(typeof onvrdisplayconnect, "onvrdisplayconnect")
rec(typeof onvrdisplaydeactivate, "onvrdisplaydeactivate")
rec(typeof onvrdisplaydisconnect, "onvrdisplaydisconnect")
rec(typeof onvrdisplaypresentchange, "onvrdisplaypresentchange")
rec(typeof onwaiting, "onwaiting")
rec(typeof onwebkitanimationend, "onwebkitanimationend")
rec(typeof onwebkitanimationiteration, "onwebkitanimationiteration")
rec(typeof onwebkitanimationstart, "onwebkitanimationstart")
rec(typeof onwebkittransitionend, "onwebkittransitionend")
rec(typeof onwheel, "onwheel")
rec(typeof open, "open")
rec(typeof opener, "opener")
rec(typeof origin, "origin")
rec(typeof outerHeight, "outerHeight")
rec(typeof outerWidth, "outerWidth")

rec(typeof pageXOffset, "pageXOffset")
rec(typeof pageYOffset, "pageYOffset")
rec(typeof parent, "parent")
rec(typeof postMessage, "postMessage")
rec(typeof print, "print")
rec(typeof prompt, "prompt")

rec(typeof queueMicrotask, "queueMicrotask")

rec(typeof releaseEvents, "releaseEvents")
rec(typeof removeEventListener, "removeEventListener")
rec(typeof reportError, "reportError")
rec(typeof requestAnimationFrame, "requestAnimationFrame")
rec(typeof requestIdleCallback, "requestIdleCallback")
rec(typeof resizeBy, "resizeBy")
rec(typeof resizeTo, "resizeTo")

rec(typeof screenLeft, "screenLeft")
rec(typeof screenTop, "screenTop")
rec(typeof screenX, "screenX")
rec(typeof screenY, "screenY")
rec(typeof scroll, "scroll")
rec(typeof scrollBy, "scrollBy")
rec(typeof scrollByLines, "scrollByLines")
rec(typeof scrollByPages, "scrollByPages")
rec(typeof scrollMaxX, "scrollMaxX")
rec(typeof scrollMaxY, "scrollMaxY")
rec(typeof scrollTo, "scrollTo")
rec(typeof scrollX, "scrollX")
rec(typeof scrollY, "scrollY")
rec(typeof self, "self")
rec(typeof setInterval, "setInterval")
rec(typeof setResizable, "setResizable")
rec(typeof setTimeout, "setTimeout")
rec(typeof sizeToContent, "sizeToContent")
rec(typeof status, "status")
rec(typeof statusbar, "statusbar")
rec(typeof stop, "stop")

rec(typeof toolbar, "toolbar")
rec(typeof top, "top")

rec(typeof updateCommands, "updateCommands")

rec(typeof window, "window")

//  these all have properties + sometimes nested
rec(typeof caches, "caches")
rec(typeof clientInformation, "clientInformation")
rec(typeof chrome, "chrome")
rec(typeof cookieStore, "cookieStore")
rec(typeof crypto, "crypto")
rec(typeof customElements, "customElements")
rec(typeof external, "external")
rec(typeof history, "history")
rec(typeof indexedDB, "indexedDB")
rec(typeof localStorage, "localStorage")
rec(typeof location, "location")
rec(typeof locationbar, "locationbar")
rec(typeof menubar, "menubar")
rec(typeof navigation, "navigation")
rec(typeof navigator, "navigator")
rec(typeof opr, "opr")
rec(typeof performance, "performance")
rec(typeof personalbar, "personalbar")
rec(typeof screen, "screen")
rec(typeof scrollbars, "scrollbars")
rec(typeof sessionStorage, "sessionStorage")
rec(typeof speechSynthesis, "speechSynthesis")
rec(typeof styleMedia, "styleMedia")
rec(typeof trustedTypes, "trustedTypes")
rec(typeof u2f, "u2f")
rec(typeof visualViewport, "visualViewport")
rec(typeof webkitStorageInfo, "webkitStorageInfo")
//InstallTrigger : being deprecated

		output()
	} catch(e) {
		console.error(e.name, e.message)
	}
}

function scrape() {
	domresult.innerHTML = "<br>... running"
	// delay so user sees changes
	setTimeout(function() {
		tstart = performance.now()
		let result = collectProps().window

		// cleanup
		delete result.dom // just in case
		delete result.collectProps
		delete result.copyclip
		delete result.logList
		delete result.mini
		delete result.mini_sha1
		delete result.output
		delete result.rec
		delete result.rerun
		delete result.reset
		delete result.run
		delete result.scrape
		delete result.sha1
		//console.log(result)

		domresult.innerHTML = JSON.stringify(result, null, 2)
		domperf.innerHTML = Math.round((performance.now() - tstart)) +" ms | "
	}, 100)
}

reset()
run()

</script>
</body>
</html>
