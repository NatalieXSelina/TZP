<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>scripts</title>
<style>
</style>
</head>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport">
	<title>scripts</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 90%; min-width: 600px; max-width: 1600px}
		ul.nomargin {padding-left: 0;}
		hr {color: #8ca7dc}
		#ugSpan {font-size: 10000%;}
		a.sb {color: #dc8c8c;}
	</style>
</head>
<body>

	<div class="offscreen">
		<div id="ugDiv" class="normalized" style='font-size: 22pt;'><span id="ugSpan"><span id="ugSlot"></span></span></div>
	</div>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb12">
		<col width="20%"><col width="80%">
		<thead><tr><th colspan="2">
			<div class="nav-title">scripts
			<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">Testing font visibility vs script support by checking up to <code>x</code>
			characters of each script for tofu. Allow 1-2 secs before running to ensure <a target="_blank" class="blue"
			href="https://bugzilla.mozilla.org/1676966">asynchronous font fallback</a> caching.
			Tofu results are colored coded as <span class="bad">90% or higher</span>, <span class="s2">20-90%</span>,
			<span class="s4">20% or lower</span>. Non-assigned code points are excluded in <span class="s14">[ranges]</span>,
			which may or may not be the full ranges. The option to not include <span style="color: #8ca7dc;">all assigned
			code points</span>, excludes some code points (to reduce the noise) which may not be supported on older
			systems with older font versions.
		</td></tr>
		<tr>
			<td class="mono spaces" id="legend" style="text-align: left; vertical-align: top; color: #b3b3b3; font-size: 11px;">
			</td>
			<td style="text-align: left; vertical-align: top; font-size: 11px;">
				<span class="btn12 btnfirst" onClick="run('test')">[ run ]</span>
				<span class="btn12 btn" onClick="logObject('codes')">[ codes ]</span>
				<span class="btn12 btn" onClick="logObject('chars')">[ chars ]</span> | &nbsp
				<span class="s12 mono"> depth
					<input type="radio" name="depth" value=20>20
					<input type="radio" name="depth" value=50 checked>50
					<input type="radio" name="depth" value=500>ALL
				</span> | &nbsp
				<span class="s12 mono">
					<input type="checkbox" name="allassigned" style="margin: 0; height: 12px" onClick='generate()'> all assigned code points
				</span>
				<br><br><hr>
				<br><span class="spaces" style="direction:ltr;unicode-bidi:bidi-override; font-size: 12px;" id="visual"></span>
			</td></tr>
	</table>
	<br>

<script>
'use strict';
// https://en.wikipedia.org/wiki/List_of_Unicode_characters

let oCodes = {},
	oChars = {},
	oRanges = {},
	aLegend = [],
	aVisual = [],
	aSummary = [],
	aBlocks = [
		// name, prefix, [block range], remove last x, [non-assigned], [ignore]
		["basic latin", "00", [2,3,4,5,6,7], -2,
			[],
			["20"]
		],
		["latin-1 supplement", "00", ["A","B","C","D","E","F"], 0,[],["A0"]],
		["latin extended-a", 0, [10,11,12,13,14,15,17], 0],
		["latin extended-b", 0, [18,19,"1A","1B","1C","1D","1E","1F", 20, 21,22,23,24], 0],
		["latin extended additional", "1E", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0,
			[],
			["9C","9D","9F","FA","FB","FC","FD","FE","FF",] // Medievalist additions
		],
		["ipa extensions", "02", [5,6,7,8,9,"A"], 0],
		["spacing modifier letters", "02", ["B","C","D","E","F"], 0],
		["combining diacritical marks", "03", [0,1,2,3,4,5,6], 0],
		["greek and coptic", "03", [7,8,9,"A","B","C","D","E","F"], 0,
			["78","79","80","81","82","83","8B","8D","A2"],
			["70","71","72","73","76","77","7F","CF"]
		],
		["cyrillic", "04", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0],
		["cyrillic supplement", 0, [50], 0],
		["armenian", "05", [3,4,5,6,7,8], 0,
			["30","57","58","8B","8C"],
			["60","88","8D","8E","8F",]
		],
		["hebrew", "05", [9,"A","B","C","D","E","F"], -11,
			["90","C8","C9","CA","CB","CC","CD","CE","CF","EB","EC","ED","EE",],
			["EF"]
		],
		["arabic", "06", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0,
			[],
			["04","05","1D","20","5F"]
		],
		["arabic supplement", "07", [5,6,7], 0,
			[],
			["6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E","7F"]
		],
		["syriac", "07", [0,1,2,3,4], 0,["0E","4B","4C"]],
		["thanaa", "07", [8,9,"A","B"], -14],
		["devanagari", "09", [0,1,2,3,4,5,6,7], 0,
			[],
			["00","3A","3B","4E","4F","55","56","57","73","74","75","76","77","78","79","7A"],
		],
		["bengali", "09", [8,9,"A","B","C","D","E","F"], -1,
			["84","8D","8E","91","92","A9","B1","B3","B4","B5","BA","BB","C5","C6","C9","CA","CF",
			"D0","D1","D2","D3","D4","D5","D6","D8","D9","DA","DB","DE","E4","E5"],
			["80","FB","FC","FD","FE"]
		],
		["gurmukhi", "0A", [0,1,2,3,4,5,6,7], -9,
			["00","04","0B","0C","0D","0E","11","12","29","31","34","37","3A","3B","3D",
			"43","44","45","46","49","4A","4E","4F","50","52","53","54","55","56","57","58",
			"5D","5F","60","61","62","63","64","65"],
			["76"]
		],
		["gujarati", "0A", [8,9,"A","B","C","D","E","F"], 0,
			["80","84","8E","92","A9","B1","B4","BA","BB","C6","CA","CE","CF",
			"D1","D2","D3","D4","D5","D6","D7","D8","D9","DA","DB","DC","DD","DE","DF",
			"E4","E5","F2","F3","F4","F5","F6","F7","F8"],
			["F0","F9","FA","FB","FC","FD","FE","FF"]
		],
		["oriya", "0B", [0,1,2,3,4,5,6,7], -8,
			["00","04","0D","0E","11","12","29","31","34","3A","3B","45","46","49","4A","4E","4F",
			"50","51","52","53","54","58","59","5A","5B","5E","64","65"],
			["55","72","73","74","75","76","77"]
		],
		["tamil", "0B", [8,9,"A","B","C","D","E","F"], -5,
			["80","81","84","8B","8C","8D","91","96","97","98","9B","9D",
			"A0","A1","A2","A5","A6","A7","AB","AC","AD","BA","BB","BC","BD",
			"C3","C4","C5","C9","CE","CF",
			"D1","D2","D3","D4","D5","D6","D8","D9","DA","DB","DC","DD","DE","DF",
			"E0","E1","E2","E3","E4","E5"],
			[],
		],
		["telugu", "0C", [0,1,2,3,4,5,6,7], 0,
			["0D","11","29","3A","3B","45","49","4E","4F",
			"50","51","52","53","54","57","5B","5C","5E","5F",
			"64","65","70","71","72","73","74","75","76"],
			["00","04","34","3C","5A","5D","77"]
		],
		["kannada", "0C", [8,9,"A","B","C","D","E","F"], -13,
			["8D","91","A9","B4","BA","BB","C5","C9","CE","CF",
			"D0","D1","D2","D3","D4","D7","D8","D9","DA","DB","DC","DF","E4","E5","F0"],
			["80","81","84","DD"]
		],
		["malayalam", "0D", [0,1,2,3,4,5,6,7], 0,
			["0D","11","45","49","50","51","52","53","64","65"],
			["00","01","04","29","3A","3B","3C","4E","4F",
			"54","55","56","58","59","5A","5B","5C","5D","5E","5F","76","77","78"]
		],
		["sinhala", "0D", [8,9,"A","B","C","D","E","F"], -11,
			["80","84","97","98","99","B2","BC","BE","BF","C7","C8","C9","CB","CC","CD","CE","D5","D7",
			"E0","E1","E2","E3","E4","E5","F0","F1"],
			["81","E6","E7","E8","E9","EA","EB","EC","ED","EE","EF"]
		],
		["thai", "0E", [0,1,2,3,4,5], -4,
			["00","3B","3C","3D","3E"],
			[]
		],
		["lao", "0E", [8,9,"A","B","C","D"], 0,
			["80","83","85","8B","A4","A6","BE","BF","C5","C7","CE","CF","DA","DB"],
			["86","89","8C","8E","8F","90","91","92","93","98","A0","A8","A9","AC","BA","DE","DF"]
		],
		["tibetan", "0F", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D"], -5,
			["48","6D","6E","6F","70","98","BD","CD"],
			["6B","6C","8C","8D","8E","8F","CE","D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","DA"]
		],
		["myanmar", 10, [0,1,2,3,4,5,6,7,8,9], 0,],
		["georgian", 10, ["A","B","C","D","E","F"], 0,
			["C6","C8","C9","CA","CB","CC","CE","CF"],
			["C7","CD","FD","FE","FF"],
		],
		["hangul jamo", 11, [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0,
			[],
			["FA","FB","FC","FD","FE","FF"]
		],
		["ethiopic", 1, [20,21,22,23,24,25,26,27,28,29,"2A","2B","2C","2D","2E","2F",30,31,32,33,34,35,36,37], -3,
			["249","24E","24F","257","259","25E","25F","289","28E","28F","2B1","2B6","2B7","2BF",
			"2C1","2C6","2C7","2D7","311","316","317","35B","35C"],
			["35D","35E"]
		],
		["ethiopic supplement", "13", [8,9], -6],
		["cherokee", 13, ["A","B","C","D","E","F",], -2, ["F6","F7"], ["F5","F8","F9","FA","FB","FC","FD"]],
		["buhid", 17, [4,5,], -12],
		["tagalog", 17, [0,1,], 0, ["16","17","18","19","1A","1B","1C","1D","1E"]],
		["hanunoo", 17, [2,3], -9],
		["tagbanwa", 17, [6,7], -12, ["6D","71"]],
		["khmer", 17, [8,9,"A","B","C","D","E","F"], -6, ["DE","DF","EA","EB","EC","ED","EE","EF","FA","FB","FC","FD","FE","FF"]],
		["mongolian", 18, [0,1,2,3,4,5,6,7,8,"A"], -5,["1A","1B","1C","1D","1E","1F","79","7A","7B","7C","7D","7E","7F"], ["78","AA"]],
		["tai le", 19, [5,6,7], -11, ["6E","6F"]],
		["new tai lue", 19, [8,9,"A","B","C","D"], 0, ["AC","AD","AE","AF","CA","CB","CC","CD","CE","CF","DB","DC","DD"]],
		["javanese", "A9", [8,9,"A","B","C","D"], 0, ["CE","DA","DB","DC","DD"]],

		["adlam", "1E9", [0,1,2,3,4,5], 0, ["4C","4D","4E","4F","5A","5B","5C","5D"]],
		["bamum", "A6", ["A","B","C","D","E","F"], -8],
		["bassa vah", "16A", ["D","E","F"], -10,["EE","EF"]],
		["medefaidrin ", "16E", [4,5,6,7,8,9], -5],
		["vai", "A", [50,51,52,53,54,55,56,57,58,59,"5A","5B","5C","5D","5E","5F",60,61,62], -4],
		["mandaic", "08", [4,5], -1,["5C","5D"]],
		["samaritan", "08", [0,1,2,3], -1,["2E","2F"]],

/*
unified canadian aboriginal syllabics
ogham
runic
greek extended
currency symbols
combining diacritical marks for symbols


		["name", 0, ["","","",""], 0,
			["","","",""],
			["","","",""]
		],
*/

	]

s2 = s2.trim()
s3 = s3.trim()
s4 = s4.trim()
s5 = s5.trim()
s12 = s12.trim()
s14 = s14.trim()
sg = sg.trim()
sb = sb.trim()

let tofuSize

function strip(value) {
	// strip all spaces
	return value.replace(/ /g,"")
}

function get_tofu_size() {
	// measure some known unassigned + reserved unicode glyphs
	return new Promise(resolve => {
		// list: assigned codepoints for testing: '0x20B9','0xA840'
		let list = ['0x20B9','0xA840','0x07BF','0x20CF','0xA87F','0x09D2','0x0A7F']
		let div = dom.ugDiv, span = dom.ugSpan, slot = dom.ugSlot
		let res = []
		for (let i=0; i < list.length; i++) {
			slot.style.fontFamily = "none"
			slot.textContent = String.fromCodePoint(list[i])
			let w = span.offsetWidth, h = div.offsetHeight
			res.push(w +" x "+ h)
		}
		// reset slot so we don't end up with unwanted scrollbars
		slot.textContent = ""
		// get most common size
		let getGreatestOccurrence = res => res.reduce((greatest , currentValue, index, res) => {
			let count = res.filter(item => JSON.stringify(item) == JSON.stringify(currentValue)).length
			if (count > greatest.count) {
				return {count, item: currentValue}
			}
			return greatest
		}, { count: 0, item: undefined })
		let greatest = getGreatestOccurrence(res)
		tofuSize = greatest.item
		//console.log("tofu test sizes", res)
		//console.log("tofu size", tofuSize)
		return resolve()
	})
}

function logObject(name) {
	let notation = (dom.allassigned.checked ? " [all assigned codepoints]" : "")
	if (name == "codes") {
		console.log("CODES"+ notation +"\n", oCodes)
	} else {
		console.log("CHARS"+ notation +"\n", oChars)
	}
}

function generate() {
	// generate codes and characters
	return new Promise(resolve => {
		let t0 = performance.now()
		let aSuffix = [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"]
		aBlocks.forEach(function(data) {
			let name = data[0].toLowerCase(),
				prefix = data[1],
				range = data[2],
				remove = data[3],
				nonassigned = data[4],
				ignore = data[5]
			oCodes[name] = []
			oChars[name] = []
			// what to skip
			let hasSkip = false
			let skip = []
			if (nonassigned !== undefined) {skip = skip.concat(nonassigned)}
			if (dom.allassigned.checked == false) {
				if (ignore !== undefined) {skip = skip.concat(ignore)}
			}
			if (skip.length > 0) {
				hasSkip = true
			}
			// build
			let aCodes = []
			let aChars = []
			for (let i = 0; i < range.length; i++) {
				oRanges[name] = []
				oRanges[name].push(""+ prefix + range[0] +"0-"+ prefix + range[range.length-1] +"F")
				for (let j = 0; j < aSuffix.length; j++) {
					let string = "0x"+ prefix + range[i] + aSuffix[j]
					if (hasSkip) {
						if (!skip.includes(""+ range[i] + aSuffix[j])) {
							aCodes.push(string)
							aChars.push(String.fromCodePoint(string))
						}
					} else {
						aCodes.push(string)
						aChars.push(String.fromCodePoint(string))
					}
				}
			}
			if (remove == 0 || remove == undefined) {
				oCodes[name] = aCodes
				oChars[name] = aChars
			} else {
				oCodes[name] = aCodes.slice(0, remove)
				oChars[name] = aChars.slice(0, remove)
			}
		})
		//console.log("perf: generating blocks", performance.now() - t0, "ms")
		// always setup if we change our code lists
		setup()
		// return
		return resolve()
	})
}

function setup() {
	// simple clean function to reset everything
		// and initially to make sure we display all code points
	aVisual = []
	aLegend = []
	dom.perf.innerHTML = "&nbsp"
	const names = Object.keys(oCodes)
	for (const k of names) {
		let anchor = strip(k)
		let chars = oChars[k]
		let display = []
		for (let i=0; i < chars.length; i++) {
			display.push(chars[i])
		}
		aLegend.push("<a class='no_color' href='#"+ anchor +"'>"+ k +"</a>")
		aVisual.push("<span class='mono'>"+ s12 + "<a name='"+ anchor + "'></a>"+ k
			+" ["+ chars.length +"]"+ sc + s14 +" ["+ oRanges[k][0] + "]"+ sc + sc)
		aVisual.push(display.join(" ") + "<br>")
	}
		// output
		dom.legend.innerHTML = s12 +"SCRIPTS [" + aBlocks.length +"]" + sc
			+ "<br><ul class='nomargin'><li>"+ aLegend.join("</li><li>") + "</ul>"
		dom.visual.innerHTML = aVisual.join("<br>")
}


function run() {
	if (isRunning) {return}
	isRunning = true
	// we need to retest tofu size in case user zoomed
	Promise.all([
		get_tofu_size(),
		setup()
	]).then(function(results){
		dom.perf.innerHTML = "running ..."
		setTimeout(function() {
			test()
		}, 1)
	})
}

function test() {
	// reset vars
	aVisual = []
	aLegend = []
	aSummary = []
	dom.perf.innerHTML = "&nbsp"
	// vars
	let div = dom.ugDiv, span = dom.ugSpan, slot = dom.ugSlot
	let t0 = performance.now()
	slot.style.fontFamily = "none"
	let testDepth = document.querySelector('input[name="depth"]:checked').value
	let aRed = [], aOrange = [], aYellow = []

	// methods: setup, test
	const names = Object.keys(oCodes)
	for (const k of names) {
		let anchor = strip(k)
		let chars = oChars[k]
		let displayA = []
		let displayB = []
		let tofuCount = 0
		let anchorColor = "no_color", nameColor = s12, partial = ""
		let	maxDepth = (testDepth > chars.length ? chars.length : testDepth)
		maxDepth = maxDepth * 1

		// split into test and remainder
		let charsA = chars.slice(0, maxDepth)
		let charsB = chars.slice(maxDepth, chars.length)

		// test
		for (let i=0; i < charsA.length; i++) {
			let character = charsA[i]
			slot.textContent = character
			let w = span.offsetWidth, h = div.offsetHeight
			if (w +" x "+ h == tofuSize) {
				tofuCount++
				displayA.push(sb + character + sc)
			} else {
				displayA.push(character)
			}
			//console.log(w +" x "+ h)
		}
		// remainder
		if (charsB.length > 0) {
			//displayA.push(sg + "&#x25C0" + sc) // show test marker
			displayB = charsB
		}
		// colors
		let percent = (tofuCount/maxDepth) * 100
		let strA = displayA.join(" ")
		if (percent >= 90) {
			anchorColor = "sb"
			nameColor = sb
			if (percent !== 100) {partial = " ["+ tofuCount +"/" + maxDepth +"]"}
			aRed.push(sb + k + sc + partial)
			if (percent !== 100) {partial = sb + partial +"]"}
		} else if (percent >= 20) {
			anchorColor = "s2"
			nameColor = s2
			partial = " ["+ tofuCount +"/" + maxDepth +"]"
			strA = strA.replace(/bad/g, "s2")
			aOrange.push(s2 + k + sc + partial)
			partial = s2 + partial + sc
		} else if (percent > 0) {
			//anchorColor = "s4" // too noisy, just let the count be colored
			nameColor = s4
			partial = " ["+ tofuCount +"/" + maxDepth +"]"
			strA = strA.replace(/bad/g, "s4")
			aYellow.push(s4 + k + sc + partial)
			partial = s4 + partial + sc
		}
		// display
		aLegend.push("<a class='"+ anchorColor +"' href='#"+ anchor +"'>"+ k +"</a>" + partial)
		aVisual.push("<span class='mono'>"+ nameColor + "<a name='"+ anchor + "'></a>"+ k + sc
			+ s12 + " ["+ chars.length +"]"+ sc + s14 +" ["+ oRanges[k][0] + "]"+ sc + partial + sc)
		aVisual.push(strA + " " + displayB.join(" ") +"<br>")
	}

	// reset slot so we don't end up with unwanted scrollbars
	slot.textContent = ""

	// summary
	if (aRed.length) {
		aSummary.push("<br>"+ sb + "unsupported [" + aRed.length +"]"+ sc +"<br>")
		aSummary.push("<br>"+ aRed.join("<br>") +"<br>")
	}
	if (aOrange.length) {
		aSummary.push("<br>"+ s2 + "mixed [" + aOrange.length +"]"+ sc +"<br>")
		aSummary.push("<br>" + aOrange.join("<br>") +"<br>")
	}
	if (aYellow.length) {
		aSummary.push("<br>"+ s4 + "partial [" + aYellow.length +"]"+ sc +"<br>")
		aSummary.push("<br>"+ aYellow.join("<br>"))
	}

	// output
	let summaryBtn = " <span class='btn12 btnfirst' onClick='copyclip(`copy`)'>[ copy ]</span>"
	dom.legend.innerHTML = s12 +"SCRIPTS ["+ aBlocks.length +"]" + sc
		+ " <a class='blue' href='#summary'>#SUMMARY</a>"
		+ "<br><ul class='nomargin'><li>"+ aLegend.join("</li><li>") + "</ul>"
		+ "<br><span id='summary'></span>"+ s12 +"SUMMARY" + sc + summaryBtn +"<br>"
		+ "<span id='copy'>"+ aSummary.join(" ") +"</span>"
	dom.visual.innerHTML = aVisual.join("<br>")

	// perf
	dom.perf.innerHTML = Math.round(performance.now() - t0) + " ms"
	isRunning = false
}

dom.allassigned.checked = true
let isRunning = false
aBlocks.sort() // sort so results are easier to scan
generate()


</script>
</body>
</html>
