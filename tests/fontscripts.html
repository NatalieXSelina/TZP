<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>scripts</title>
<style>
</style>
</head>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport">
	<title>scripts</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 90%; min-width: 600px; max-width: 1600px}
		ul.nomargin {padding-left: 0;}
		hr {color: #8ca7dc}
		#ugSpan {font-size: 10000%;}
		a.sb {color: #dc8c8c;}
		.groupleft {float: left;}
		.groupright {float: right;}
	</style>
</head>
<body>

	<div class="offscreen">
		<div id="ugDiv" class="normalized" style='font-size: 22pt;'><span id="ugSpan"><span id="ugSlot"></span></span></div>
	</div>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb12">
		<col width="20%"><col width="80%">
		<thead><tr><th colspan="2">
			<div class="nav-title">scripts
			<div class="nav-up"><span class="c perf" id="perf"></span></div>
			<div class="nav-down"><span class="c perf" id="tofuSize"></span></div></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">Testing font visibility vs script support <span class="s14">[unicode v14.0]</span>
			by checking up to <code>x</code> characters of each script for tofu. Allow 2-3 secs before running
			to ensure <a target="_blank" class="blue" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1676966#c54">
			asynchronous font fallback</a> caching. Tofu results are colored coded as <span class="bad">90% or higher</span>,
			<span class="s2">20-90%</span>, <span class="s4">20% or lower</span>.
			Click the script name in the display area to log code points to console.
		</td></tr>
		<tr>
			<td class="mono spaces" id="legend" style="text-align: left; vertical-align: top; color: #b3b3b3; font-size: 11px;">
			</td>
			<td style="text-align: left; vertical-align: top;">
				<span class="btn12 btnfirst" onClick="run('test')">[ run ]</span>
				<!--<span class="btn12 btn" onClick="logObject('codes')">[ codes ]</span>
				<span class="btn12 btn" onClick="logObject('chars')">[ chars ]</span> | &nbsp-->
				<span class="s12 mono"> depth
					<input type="radio" name="depth" value=20 checked> 20
					<input type="radio" name="depth" value=50> 50
					<input type="radio" name="depth" value=800> ALL
				</span> | &nbsp
				<span class="s12 mono">
					<input type="checkbox" name="allassigned" style="margin: 0; height: 12px" onClick='reset()'> all assigned code points
					<div class="ttip"><span class="icon">[ i ]</span>
						<span class="ttxtb" style="font-style: normal; font-family: serif;">
						If unchecked, some code<br>points assigned in later<br>unicode versions are ignored<br>
						<br>e.g. Armenian<br><b>U+058F</b> (v6.1, 2012)<br><b>U+058D, U+058E</b> (v7.0, 2014)<br>
						<b>U+0560, U+0588</b> (v11.0, 2018)<br><br>This can help reduce tofu<br>noise on older
						platforms when<br>just checking basic script support,<br>as the font version may not<br>support the unicode version</span>
					</div>
				</span>
				<br><br>
				<span class="spaces" style="direction:ltr;unicode-bidi:bidi-override; font-size: 12px;" id="visual"></span>
			</td></tr>
	</table>
	<br>

<script>
'use strict';
// https://en.wikipedia.org/wiki/List_of_Unicode_characters

let aPartial =[
	// script ranges to denote as partial because they are too big
	"yi syllables" // 1,165 code points
]

let aBlocks = [
		// name, prefix, [block range], remove last x, [non-assigned], [ignore], wikiURL
		// note: first item needs to be a group name for the top anchor to work

		// AFRICAN
		["african"],
		["adlam", "1E9", [0,1,2,3,4,5], 0, ["4C","4D","4E","4F","5A","5B","5C","5D"], ,"Adlam_(Unicode_block)"],
		["bamum", "A6", ["A","B","C","D","E","F"], -8, , , "Bamum_(Unicode_block)"],
		["bassa vah", "16A", ["D","E","F"], -10, ["EE","EF"], , "Bassa_Vah_(Unicode_block)"],
		["ethiopic", 1, [20,21,22,23,24,25,26,27,28,29,"2A","2B","2C","2D","2E","2F",30,31,32,33,34,35,36,37], -3,
			["249","24E","24F","257","259","25E","25F","289","28E","28F","2B1","2B6","2B7","2BF",
			"2C1","2C6","2C7","2D7","311","316","317","35B","35C"],
			["35D","35E"], "Ethiopic_(Unicode_block)",
		],
		["ethiopic supplement", "13", [8,9], -6, , , "Ethiopic_Supplement"],
		["medefaidrin", "16E", [4,5,6,7,8,9], -5, , , "Medefaidrin_(Unicode_block)"],
		["nko", "07", ["C","D","E","F"], 0, ["FB","FC"], ["FD","FE","FF"], "NKo_(Unicode_block)"],
		["osmanya", "104", [8,9,"A"], -6, ["9E","9F"], , "Osmanya_(Unicode_block)"],
		["tifinagh", "2D", [3,4,5,6,7], 0,
			["68","69","6A","6B","6C","6D","6E","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E"],
			["66","67","70","7F"], "Tifinagh_(Unicode_block)"
		],
		["vai", "A", [50,51,52,53,54,55,56,57,58,59,"5A","5B","5C","5D","5E","5F",60,61,62], -4, , , "Vai_(Unicode_block)"],

		// AMERICAN
		["american"],
		["cherokee", 13, ["A","B","C","D","E","F",], -2, ["F6","F7"], ["F5","F8","F9","FA","FB","FC","FD"], "Cherokee_(Unicode_block)"],
		["deseret", "104", [0,1,2,3,4], , , , "Deseret_(Unicode_block)"],
		["osage", "104", ["B","C","D","E","F"], -4, ["D4","D5","D6","D7"], , "Osage_(Unicode_block)"],
		["unified canadian aboriginal syllabics", 1,
			[40,41,42,43,44,45,46,47,48,49,"4A","4B","4C","4D","4E","4F",
			50,51,52,53,54,55,56,57,58,59,"5A","5B","5C","5D","5E","5F",
			60,61,62,63,64,65,66,67], 0, [],
			["400","677","678","679","67A","67B","67C","67D","67E","67F"],
			"Unified_Canadian_Aboriginal_Syllabics_(Unicode_block)"
		],

		// ANCIENT
		["ancient and historic"],
		["gothic", 103, [3,4], -5, , , "Gothic_(Unicode_block)"],
		["ogham", 16, [8,9], -3, , , "Ogham_(Unicode_block)"],
		["old italic", 103, [0,1,2], 0, ["24","25","26","27","28","29","2A","2B","2C"], ["1F","2D","2E","2F"], "Old_Italic_(Unicode_block)"],
		["old turkic", "10C", [0,1,2,3,4], -7, , , "Old_Turkic_(Unicode_block)"],
		["runic", 16, ["A","B","C","D","E","F"], -7, [], ["F1","F2","F3","F4","F5","F6","F7","F8"], "Runic_(Unicode_block)"],

		// BRAHMIC
		["brahmic"],
		["balinese", "1B", [0,1,2,3,4,5,6,7], -1, ["4D","4E","4F"], , "Balinese_(Unicode_block)"],
		["bengali", "09", [8,9,"A","B","C","D","E","F"], -1,
			["84","8D","8E","91","92","A9","B1","B3","B4","B5","BA","BB","C5","C6","C9","CA","CF",
			"D0","D1","D2","D3","D4","D5","D6","D8","D9","DA","DB","DE","E4","E5"],
			["80","FB","FC","FD","FE"],
			"Bengali_(Unicode_block)"
		],
		["buginese", "1A", [0,1], 0, ["1C","1D"], ,"Buginese_(Unicode_block)"],
		["buhid", 17, [4,5,], -12, , , "Buhid_(Unicode_block)"],
		["devanagari", "09", [0,1,2,3,4,5,6,7], 0, ,
			["00","3A","3B","4E","4F","55","56","57","73","74","75","76","77","78","79","7A"],
			"Devanagari_(Unicode_block)"
		],
		["gujarati", "0A", [8,9,"A","B","C","D","E","F"], 0,
			["80","84","8E","92","A9","B1","B4","BA","BB","C6","CA","CE","CF",
			"D1","D2","D3","D4","D5","D6","D7","D8","D9","DA","DB","DC","DD","DE","DF",
			"E4","E5","F2","F3","F4","F5","F6","F7","F8"],
			["F0","F9","FA","FB","FC","FD","FE","FF"], "Gujarati_(Unicode_block)"
		],
		["gurmukhi", "0A", [0,1,2,3,4,5,6,7], -9,
			["00","04","0B","0C","0D","0E","11","12","29","31","34","37","3A","3B","3D",
			"43","44","45","46","49","4A","4E","4F","50","52","53","54","55","56","57","58",
			"5D","5F","60","61","62","63","64","65"],
			["76"], "Gurmukhi_(Unicode_block)"
		],
		["hanunoo", 17, [2,3], -9, , , "Hanunoo_(Unicode_block)"],
		["javanese", "A9", [8,9,"A","B","C","D"], 0, ["CE","DA","DB","DC","DD"], , "Javanese_(Unicode_block)"],
		["kannada", "0C", [8,9,"A","B","C","D","E","F"], -13,
			["8D","91","A9","B4","BA","BB","C5","C9","CE","CF",
			"D0","D1","D2","D3","D4","D7","D8","D9","DA","DB","DC","DF","E4","E5","F0"],
			["80","81","84","DD"], "Kannada_(Unicode_block)"
		],
		["khmer", 17, [8,9,"A","B","C","D","E","F"], -6,
			["DE","DF","EA","EB","EC","ED","EE","EF"], , "Khmer_(Unicode_block)"
		],
		["khmer symbols", 19, ["E","F"], , , , "Khmer_Symbols"],
		["lao", "0E", [8,9,"A","B","C","D","E","F"], -32,
			["80","83","85","8B","A4","A6","BE","BF","C5","C7","CE","CF","DA","DB"],
			["86","89","8C","8E","8F","90","91","92","93","98","A0","A8","A9","AC","BA","DE","DF"],
			"Lao_(Unicode_block)"
		],
		["malayalam", "0D", [0,1,2,3,4,5,6,7], 0,
			["0D","11","45","49","50","51","52","53","64","65"],
			["00","01","04","29","3A","3B","3C","4E","4F","54","55","56","58","59","5A","5B","5C","5D","5E","5F","76","77","78"],
			"Malayalam_(Unicode_block)"
		],
		["myanmar", 10, [0,1,2,3,4,5,6,7,8,9], 0, , , "Myanmar_(Unicode_block)"],
		["new tai lue", 19, [8,9,"A","B","C","D"], 0,
			["AC","AD","AE","AF","CA","CB","CC","CD","CE","CF","DB","DC","DD"], , "New_Tai_Lue_(Unicode_block)"
		],
		["oriya", "0B", [0,1,2,3,4,5,6,7], -8,
			["00","04","0D","0E","11","12","29","31","34","3A","3B","45","46","49","4A","4E","4F",
			"50","51","52","53","54","58","59","5A","5B","5E","64","65"],
			["55","72","73","74","75","76","77"], "Oriya_(Unicode_block)"
		],
		["phags-pa", "A8", [4,5,6,7], -8, , , "Phags-pa_(Unicode_block)"],
		["sinhala", "0D", [8,9,"A","B","C","D","E","F"], -11,
			["80","84","97","98","99","B2","BC","BE","BF","C7","C8","C9","CB","CC","CD","CE","D5","D7",
			"E0","E1","E2","E3","E4","E5","F0","F1"],
			["81","E6","E7","E8","E9","EA","EB","EC","ED","EE","EF"], "Sinhala_(Unicode_block)"
		],
		["sundanese", "1B", [8,9,"A","B"], , , , "Sundanese_(Unicode_block)"],
		["tagalog", 17, [0,1,], 0, ["16","17","18","19","1A","1B","1C","1D","1E"], , "Tagalog_(Unicode_block)"],
		["tagbanwa", 17, [6,7], -12, ["6D","71"], , "Tagbanwa_(Unicode_block)"],
		["tai le", 19, [5,6,7], -11, ["6E","6F"], , "Tai_Le_(Unicode_block)"],
		["tamil", "0B", [8,9,"A","B","C","D","E","F"], -5,
			["80","81","84","8B","8C","8D","91","96","97","98","9B","9D",
			"A0","A1","A2","A5","A6","A7","AB","AC","AD","BA","BB","BC","BD",
			"C3","C4","C5","C9","CE","CF",
			"D1","D2","D3","D4","D5","D6","D8","D9","DA","DB","DC","DD","DE","DF",
			"E0","E1","E2","E3","E4","E5"],
			[], "Tamil_(Unicode_block)"
		],
		["tamil supplement", "11F", ["C","D","E","F"], 0,
			["F2","F3","F4","F5","F6","F7","F8","F9","FA","FB","FC","FD","FE"], , "Tamil_Supplement"
		],
		["telugu", "0C", [0,1,2,3,4,5,6,7], 0,
			["0D","11","29","3A","3B","45","49","4E","4F",
			"50","51","52","53","54","57","5B","5C","5E","5F",
			"64","65","70","71","72","73","74","75","76"],
			["00","04","34","3C","5A","5D","77"], "Telugu_(Unicode_block)"
		],
		["thai", "0E", [0,1,2,3,4,5,6,7], -36, ["00","3B","3C","3D","3E"], , "Thai_(Unicode_block)"],
		["tibetan", "0F", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], -37,
			["48","6D","6E","6F","70","98","BD","CD"],
			["6B","6C","8C","8D","8E","8F","CE","D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","DA"],
			"Tibetan_(Unicode_block)"
		],

		// CYRILLIC
		["cyrillic"],
		["cyrillic", "04", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], , , , "Cyrillic_(Unicode_block)"],
		["cyrillic extended-a", "2D", ["E","F"], , , , "Cyrillic_Extended-A"],
		["cyrillic extended-b", "A6", [4,5,6,7,8,9], , ,
			["98","99","9A","9B","9C","9D","9E"], // e.g. v7.0 2014 (4), v8.0 (2)
			"Cyrillic_Extended-B"
		],
		["cyrillic extended-c", "1C", [8], -7, , , "Cyrillic_Extended-C"],
		["cyrillic supplement", "05", [0,1,2], , ,
			["14","15","16","17","18","19","1E","1F","20","21","22","23","26","27","28","29","2A","2B","2C","2D","2E","2F"],
			"Cyrillic_Supplement"
		],
		["glagolitic", "2C", [0,1,2,3,4,5], 0, [], ["2F","5F"], "Glagolitic_(Unicode_block)"],

		// EAST ASIAN
		["east asian"],
		["bopomofo", 31, [0,1,2], 0, ["00","01","02","03","04"], ["2D","2E","2F"], "Bopomofo_(Unicode_block)"],
		["bopomofo extended", 31, ["A","B"], 0, [], ["B8","B9","BA","BB","BC","BD","BE","BF"], "Bopomofo_Extended"],
		["hangul jamo", 11, [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0, [],
			["FA","FB","FC","FD","FE","FF"], "Hangul_Jamo_(Unicode_block)"
		],
		["hiragana", 30, [4,5,6,7,8,9], 0, ["40","97","98"], , "Hiragana_(Unicode_block)"],
		["kanbun", 31, [9], 0, , , "Kanbun_(Unicode_block)"],
		["katakana", 30, ["A","B","C","D","E","F"], 0, , , "Katakana_(Unicode_block)"],
		["yi radicals", "A4", [9,"A","B","C"], -9, , , "Yi_Radicals"],
		["yi syllables", "A0", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], 0, , , "Yi_Syllables"],

		// GEORGIAN
		["georgian"],
		["georgian", 10, ["A","B","C","D","E","F"], ,
			["C6","C8","C9","CA","CB","CC","CE","CF"],
			["C7","CD","FD","FE","FF"], "Georgian_(Unicode_block)"
		],
		["georgian extended", "1C", [9,"A","B"], , ["BB","BC"], , "Georgian_Extended"],
		["georgian supplement", "2D", [0,1,2], -2, ["26","28","29","2A","2B","2C"], ["27","2D"], "Georgian_Supplement"],

		// GREEK
		["greek"],
		["greek and coptic", "03", [7,8,9,"A","B","C","D","E","F"], ,
			["78","79","80","81","82","83","8B","8D","A2"],
			["70","71","72","73","76","77","7F","CF"], "Greek_and_Coptic"
		],
		["greek extended", "1F", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], -1,
			["16","17","1E","1F","46","47","4E","4F","58","5A","5C","5E","7E","7F","B5","C5","D4","D5","DC","F0","F1","F5"],
			[], "Greek_Extended"
		],

		// LATIN
		["latin"],
		["basic latin", "00", [2,3,4,5,6,7], -2, , , "Basic_Latin_(Unicode_block)"],
		["latin-1 supplement", "00", ["A","B","C","D","E","F"], , , ["A0"], "Latin-1_Supplement"],
		["latin extended-a", 0, [10,11,12,13,14,15,17], , , , "Latin_Extended-A"],
		["latin extended-b", 0, [18,19,"1A","1B","1C","1D","1E","1F", 20, 21,22,23,24], , , , "Latin_Extended-B"],
		["latin extended additional", "1E", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], , ,
			["9C","9D","9F","FA","FB","FC","FD","FE","FF"], // Medievalist additions
			"Latin_Extended_Additional"
		],

		// NOTATIONAL
		//["notational"],

		// PHONETIC
		["phonetic"],
		["ipa extensions", "02", [5,6,7,8,9,"A"], , , , "IPA_Extensions"],
		["phonetic extensions", "1D", [0,1,2,3,4,5,6,7], , , , "Phonetic_Extensions"],
		["phonetic extensions supplement", "1D", [8,9,"A","B"], , , , "Phonetic_Extensions_Supplement"],
		["spacing modifier letters", "02", ["B","C","D","E","F"], , , , "Spacing_Modifier_Letters"],

		// SEMITIC
		["semitic"],
		["arabic", "06", [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"], , , ["04","05","1D","20","5F"], "Arabic_(Unicode_block)"],
		["arabic supplement", "07", [5,6,7], , ,
			["6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E","7F"], "Arabic_Supplement"
		],
		["hebrew", "05", [9,"A","B","C","D","E","F"], -11,
			["90","C8","C9","CA","CB","CC","CD","CE","CF","EB","EC","ED","EE"], ["EF"], "Hebrew_(Unicode_block)"
		],
		["mandaic", "08", [4,5], -1, ["5C","5D"], , "Mandaic_(Unicode_block)"],
		["samaritan", "08", [0,1,2,3], -1, ["2E","2F"], , "Samaritan_(Unicode_block)"],
		["syriac", "07", [0,1,2,3,4], 0, ["0E","4B","4C"], , "Syriac_(Unicode_block)"],

		// MISC
		["misc"],
		["armenian", "05", [3,4,5,6,7,8], 0,
			["30","57","58","8B","8C"], ["60","88","8D","8E","8F"], "Armenian_(Unicode_block)"
		],
		["combining diacritical marks", "03", [0,1,2,3,4,5,6], , , , "Combining_Diacritical_Marks"],
		["currency symbols", 20, ["A","B","C"], -15, , ["B6","B7","BB","BC","BD","BE","BF","C0"], "Currency_Symbols_(Unicode_block)"],
		["letterlike symbols", 21, [0,1,2,3,4], , , ["3C","4C","4F"], "Letterlike_Symbols"],
		["general punctuation", 20, [1,2,3,4,5,6], , ["65"], , "General_Punctuation"],
		["mongolian", 18, [0,1,2,3,4,5,6,7,8,"A"], -5,
			["1A","1B","1C","1D","1E","1F","79","7A","7B","7C","7D","7E","7F"],
			["78","AA"], "Mongolian_(Unicode_block)"
		],
		["superscripts and subscripts", 20, [7,8,9], -3, ["72","73","8F"],
			["95","96","97","98","99","9A","9B","9C"], "Superscripts_and_Subscripts_(Unicode_block)"],
		["thanaa", "07", [8,9,"A","B"], -14, , , "Thaana_(Unicode_block)"],


/*
combining diacritical marks for symbols

		["name", 0, ["","","",""], 0,
			["","","",""],
			["","","",""]
		],
*/

	]

s2 = s2.trim()
s3 = s3.trim()
s4 = s4.trim()
s5 = s5.trim()
s12 = s12.trim()
s14 = s14.trim()
sg = sg.trim()
sb = sb.trim()

let oCodes = {},
	oChars = {},
	oCodesMax = {},
	oCharsMax = {},
	oCodesIgnore = {},
	oCharsIgnore = {},
	oCodesReserved = {},
	oCharsReserved = {},
	oRanges = {},
	oWiki = {},
	aLegendClean = [],
	aNav = [],
	aDisplay = [],
	aDisplayMax = [],
	oTofuSizes = {},
	tofuSize,
	countScript,
	countChars,
	countCharsMax

function strip(value) {return value.replace(/ /g,"")} 	// strip all spaces

function hyperlink(string) {return " <a target='blank' class='blue' href='"+ string +"'>wiki</a>"}

function build_title(type, name, anchor, misc, nameColor, grouptitle) {
	if (type == "script") {
		let intChars = oChars[name].length,
			intCharsMax = oCharsMax[name].length,
			count = intChars
		if (intChars !== intCharsMax) {count += "|" + intCharsMax}
		return (grouptitle !== "" ? grouptitle : "") +
			"<span class='mono'>"
				// name
				+ nameColor + "<a name='"+ anchor + "'></a>"
					+ "<span style='cursor: pointer;' onClick='logCodes(`"+ name + "`)'>" + name + sc + sc
				// char count
				+ s12 + " ["+ count +"]"+ sc
				// range
				+ s14 +" ["+ oRanges[name][0] + (aPartial.includes(name) ? " &#9664 partial" : "") +"]"+ sc
				// link
				+ (oWiki[name].length ? hyperlink(oWiki[name][0]) : "")
			+ sc
	} else if (type == "group") {
		return "<div><a name='"+ anchor + "'></a>"
			+ "<hr><p class='groupleft'>"
			+ "<u><b><a class='no_color' href='#"+ anchor +"'>"+ name +"</a></b></u>"
			+ "</p>"
			+ misc // navString
			+ "<div style='clear: both;'></div>"
			+ "</div>"
	}
}

function copysummary() {

}

function get_tofu_size() {
	// measure some known unassigned + reserved unicode glyphs
	return new Promise(resolve => {
		// list: some reserved code points
		// use multiple scripts to reduce change in greatest occurence over time
		let list = [
			'0x0402', // control: cyrillic: capital Dje
			'0x0386', // control: greek: capital A with acute
			'0x09E5', // bangali
			'0x135C', // ethiopic
			'0x10CF', // georgian
			'0x0AF8', // gujarati
			'0x0A65', // gurmukhi
			'0x03A2', // greek
			'0x0EDB', // lao
			'0x0D65', // malayam
			// log oCharsReserved to console for inspiration
			/* 
			'0x187F', // mongolian
			'0x0DF1', // sinhala
			'0x0BE5', // tamil
			'0x2D7E', // tifinagh
			*/
		]
		let styles = ["none","sans-serif","serif","monospace","cursive","fantasy"]
		let div = dom.ugDiv, span = dom.ugSpan, slot = dom.ugSlot
		let res = {}
		styles.forEach(function(style) {res[style] = []})
		oTofuSizes["test array"] = []

		list.forEach(function(codepoint) {
			oTofuSizes["test array"].push(codepoint +" "+ String.fromCodePoint(codepoint))
			styles.forEach(function(style) {
				slot.style.fontFamily = style
				slot.textContent = String.fromCodePoint(codepoint)
				let w = span.offsetWidth, h = div.offsetHeight
				res[style].push(w +" x "+ h)
			})
		})
		// reset slot so we don't end up with unwanted scrollbars
		slot.textContent = ""

		// get most common size
		const names = Object.keys(res)
		for (const k of names) {
			let aRes = res[k]
			let getGreatestOccurrence = aRes => aRes.reduce((greatest, currentValue, index, res) => {
				let count = res.filter(item => JSON.stringify(item) == JSON.stringify(currentValue)).length
				if (count > greatest.count) {
					return {count, item: currentValue}
				}
				return greatest
			}, { count: 0, item: undefined })
			let greatest = getGreatestOccurrence(aRes)
			oTofuSizes[k] = [greatest.item, aRes.join(", ")]
		}
		tofuSize = oTofuSizes["none"][0]
		dom.tofuSize.innerHTML = "<span style='cursor: pointer;' onClick='logObject(`tofu`)'>" + tofuSize +"</span>"
		return resolve()
	})
}

function logCodes(name) {
	let codes = oCodesMax[name],
		ignore = oCodesIgnore[name],
		reserved = oCodesReserved[name]
	if (aPartial.includes(name)) {name += " partial"}
	let logStr = name + " code points"
	logStr += "\n'"+ name +" assigned': ['" + codes.join("', '")+ "']"
	if (ignore.length > 0) {
		logStr += "\n'"+ name +" ignored': ['" + ignore.join("', '")+ "']"
	}
	if (reserved.length > 0) {
		logStr += "\n'"+ name +" reserved': ['" + reserved.join("', '")+ "']"
	}
	console.log(logStr)
}

function logObject(name) {
	let logStr = ""
	// tofu info
	if (name == "tofu") {
		logStr = "calculated tofu sizes [greatest occurence, results]"
		logStr += "\n==========="
		const names = Object.keys(oTofuSizes)
		for (const k of names) {
			logStr += "\n"+ k
			+ (k == "test array" ? "\n - "+ oTofuSizes[k].join(", ") : "\n - "+ oTofuSizes[k][0])
			+ (k == "test array" ? "" : "\n - "+ oTofuSizes[k][1])
		}
		console.log(logStr)
		return
	}
	let partial = "- note: some large ranges may be partial and are denoted as such; e.g. "+ aPartial[0]
	let aTemp = [] // so we can sort results
	// range info
	if (name == "ranges") {
		logStr = "ranges used [partial ranges denoted]"
		logStr += "\n==========="
		const names = Object.keys(oRanges)
		for (const k of names) {
			aTemp.push(k + (aPartial.includes(k) ? " [partial]" : "") +": "+ oRanges[k][0])
		}
		aTemp.sort()
		console.log(logStr +"\n"+ aTemp.join("\n"))
		return
	}
	// wiki urls
	if (name == "wiki") {
		console.debug("i am groot")
		logStr = "wikipedia links\n"
		const names = Object.keys(oWiki)
		for (const k of names) {
			let url = oWiki[k][0]
			if (url !== undefined && url !== "") {
				aTemp.push(k +": "+ url)
			}
		}
		aTemp.sort()
		console.log(logStr +"\n"+ aTemp.join("\n"))
		return
	}

	let oUsed = {}
	// code points
	if (name == "codes") {
		oUsed = oCodesMax
		logStr = "codepoints [assigned]\n"+ partial
	} else if (name == "codesignore") {
		logStr = "code points [ignored]\n- reduces tofu results on older platforms with older font versions\n"+ partial
		oUsed = oCodesIgnore
	} else if (name == "codesreserved") {
		logStr = "code points [reserved]\n"+ partial
		oUsed = oCodesReserved
	} else if (name == "chars") {
		logStr = "characters [asigned]\n"+ partial
		oUsed = oCharsMax
	} else if (name == "charsignored") {
		logStr = "characters [ignored]\n - reduces tofu results on older platforms with older font versions\n"+ partial
		oUsed = oCharsIgnore
	} else if (name == "charsreserved") {
		logStr = "characters [reserved]\n"+ partial
		oUsed = oCharsReserved
	}
	const names = Object.keys(oUsed)
	for (const k of names) {
		if (oUsed[k].length) {
			aTemp.push("'"+ k + (aPartial.includes(k) ? " partial": "") + "': ['"+ oUsed[k].join("', '") +"'],")
		}
	}
	aTemp.sort()
	if (aTemp.length) {
		logStr += "\n==========="
		console.log(logStr +"\n"+ aTemp.join("\n"))
	}
}

function generate() {
	// do once
	// two sets of codes and characters and clean displays
	// ignored codes/chars
	// reserved code/chars
	// range info
	// clean legend
	// get char counts
	return new Promise(resolve => {
		if (oCodes["arabic"] !== undefined) {
			console.debug("already done")
			return
		}
		aBlocks.forEach(function(data) {
			let name = data[0].toLowerCase()
			let anchor = strip(name) +"group"
			if (data[1] == undefined) {
				aNav.push(anchor)
			}
		})

		countScript = 0
		countChars = 0
		countCharsMax = 0

		let t0 = performance.now()
		let aSuffix = [0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"]
		let navIndex = 0,
			navString ="",
			navTop = "<a class='blue' href='#" + aBlocks[0][0].toLowerCase() +"group'> &#9650 TOP</a> &nbsp ",
			navEnd = "<a class='blue' href='#end'> &#9660 END</a></p>",
			grouptitle = ""

		aBlocks.forEach(function(data) {
			let name = data[0].toLowerCase()
			let anchor = strip(name)
			if (data[1] == undefined) {
				// script groups
				name = name.toUpperCase()
				anchor += "group"
				navString = "<p class='groupright'>"
				if (anchor !== aNav[0]) {
					navString += navTop + "<a class='blue' href='#"+ aNav[navIndex - 1] +"'> &#9664 PREV</a> &nbsp "
				}
				if (aNav[navIndex + 1] !== undefined) {
					navString += "<a class='blue' href='#"+ aNav[navIndex + 1] +"'> &#9654 NEXT</a> &nbsp "
				}
				navString += navEnd
				navIndex++
				aLegendClean.push("<br><a class='blue' href='#"+ anchor +"'>"+ name +"</a><br>")
				grouptitle = build_title("group", name, anchor, navString)
			} else {
				countScript++
				if (data[1] == undefined) {
					// sub header
					name = name.toUpperCase()
				} else {
					name = data[0].toLowerCase()
					let prefix = data[1],
						range = data[2],
						remove = data[3],
						nonassigned = data[4],
						ignore = data[5],
						url = data[6]
					// fixup vars
					if (nonassigned == undefined) {nonassigned = []}
					if (ignore == undefined) {ignore = []}
					if (remove == undefined) {remove = 0}
					// range info
					oRanges[name] = []
					let rangeString = ""+ prefix + range[0] +"0-"+ prefix + range[range.length-1] +"F"
					oRanges[name].push(rangeString)
					// wikiurl info
					oWiki[name] = []
					if (url !== undefined && url !== "") {
						oWiki[name] = ["https://en.wikipedia.org/wiki/"+ url]
					}
					// legend
					aLegendClean.push("<li><a class='no_color' href='#"+ anchor +"'>"+ name +"</a></li>")
					// vars
					oCodes[name] = []
					oCodesMax[name] = []
					oCodesIgnore[name] = []
					oCodesReserved[name] = []
					oChars[name] = []
					oCharsMax[name] = []
					oCharsIgnore[name] = []
					oCharsReserved[name] = []

					let aCodes = [],
						aCodesMax = [],
						aCodesIgnore = [],
						aCodesReserved = [],
						aChars = [],
						aCharsMax = [],
						aCharsIgnore = [],
						aCharsReserved = []

					// loop
					for (let i = 0; i < range.length; i++) {
						for (let j = 0; j < aSuffix.length; j++) {
							let string = "0x"+ prefix + range[i] + aSuffix[j]
							let match = ""+ range[i] + aSuffix[j]
							// always skip nonassigned
							if (!nonassigned.includes(match)) {
								// max
								aCodesMax.push(string)
								aCharsMax.push(String.fromCodePoint(string))
								// 
								if (!ignore.includes(match)) {
									aCodes.push(string)
									aChars.push(String.fromCodePoint(string))
								} else {
									aCodesIgnore.push(string)
									aCharsIgnore.push(String.fromCodePoint(string))
								}
							} else {
								aCodesReserved.push(string)
								aCharsReserved.push(String.fromCodePoint(string))
							}
						}
					}
					// trim results
					if (remove < 0) {
						aCodes = aCodes.slice(0, remove)
						aCodesMax = aCodesMax.slice(0, remove)
						aChars = aChars.slice(0, remove)
						aCharsMax = aCharsMax.slice(0, remove)
					}
					// record
					oCodes[name] = aCodes
					oCodesMax[name] = aCodesMax
					oCodesIgnore[name] = aCodesIgnore
					oCodesReserved[name] = aCodesReserved
					oChars[name] = aChars
					oCharsMax[name] = aCharsMax
					oCharsIgnore[name] = aCharsIgnore
					oCharsReserved[name] = aCharsReserved
					// counts
					countChars += aCodes.length
					countCharsMax += aCodesMax.length

					// build clean displays
					let nameColor = s12
					aDisplay.push(build_title("script", name, anchor, "", nameColor, grouptitle))
					aDisplay.push(aChars.join(" ") + "<br>")
					aDisplayMax.push(build_title("script", name, anchor, "", nameColor, grouptitle))
					aDisplayMax.push(aCharsMax.join(" ") + "<br>")
					// reset grouptitle
					grouptitle = ""
				}
			}
		})
		aDisplay.push("<a name='end'></a>")
		aDisplayMax.push("<a name='end'></a>")
		dom.perf.innerHTML = "setup: "+ Math.round(performance.now() - t0) +" ms | "
			+ (dom.allassigned.checked ? countCharsMax : countChars) + " chars"
		/*
		logObject("codes")
		logObject("codesignore")
		logObject("codesreserved")
		logObject("chars")
		logObject("charsignore")
		logObject("charsreserved")
		logObject("ranges")
		logObject("wiki")
		*/
		// return
		return resolve()
	})
}

function reset(clear = true) {
	// reset/display everything to make sure all code points have time to hopefully render
	if (clear) {
		dom.perf.innerHTML = (dom.allassigned.checked ? countCharsMax : countChars) + " chars"
	}
	dom.legend.innerHTML = s12 +"SCRIPTS [" + countScript +"]" + sc
		+ "<br>"+ aLegendClean.join("")
	dom.visual.innerHTML = dom.allassigned.checked ? aDisplayMax.join("<br>") : aDisplay.join("<br>")
	// add char counts
	if (!clear) {isRunning = false}
}

function run() {
	if (!isRunning) {
		// we need to retest tofu size in case user zoomed
		Promise.all([
			reset(),
			get_tofu_size()
		]).then(function(results){
			isRunning = true
			dom.perf.innerHTML = "running ..."
			setTimeout(function() {
				test()
			}, 1)
		})
	}
}

function test() {
	dom.perf.innerHTML = "&nbsp"
	// vars
	let aVisual = [],
		aLegend = [],
		aSummary = [],
		countTested = 0,
		countTofu = 0
	let div = dom.ugDiv, span = dom.ugSpan, slot = dom.ugSlot
	let t0 = performance.now()
	slot.style.fontFamily = "none"
	let testDepth = document.querySelector('input[name="depth"]:checked').value
	let aRed = [], aOrange = [], aYellow = []

	let navIndex = 0,
		navString ="",
		navTop = "<a class='blue' href='#" + aBlocks[0][0].toLowerCase() +"group'> &#9650 TOP</a> &nbsp ",
		navEnd = "<a class='blue' href='#end'> &#9660 END</a></p>",
		grouptitle = ""

	aBlocks.forEach(function(data) {
		let name = data[0].toLowerCase()
		let anchor = strip(name)
		if (data[1] == undefined) {
				// script groups
				name = name.toUpperCase()
				anchor += "group"
				navString = "<p class='groupright'>"
				if (anchor !== aNav[0]) {
					navString += navTop
						+ "<a class='blue' href='#"+ aNav[navIndex - 1] +"'> &#9664 PREV</a> &nbsp "
				}
				if (aNav[navIndex + 1] !== undefined) {
					navString += "<a class='blue' href='#"+ aNav[navIndex + 1] +"'> &#9654 NEXT</a> &nbsp "
				}
				navString += navEnd
				navIndex++
				aLegend.push("<br><a class='blue' href='#"+ anchor +"'>"+ name +"</a><br>")
				grouptitle = build_title("group", name, anchor, navString)
		} else {
			let chars = dom.allassigned.checked ? oCharsMax[name] : oChars[name]
			let displayA = []
			let displayB = []
			let tofuCount = 0
			let anchorColor = "no_color", nameColor = s12, partial = ""
			let	maxDepth = (testDepth > chars.length ? chars.length : testDepth)
			maxDepth = maxDepth * 1

			// split into test and remainder
			let charsA = chars.slice(0, maxDepth)
			let charsB = chars.slice(maxDepth, chars.length)
			countTested += charsA.length

			// test
			for (let i=0; i < charsA.length; i++) {
				let character = charsA[i]
				slot.textContent = character
				let w = span.offsetWidth, h = div.offsetHeight
				if (w +" x "+ h == tofuSize) {
					tofuCount++
					displayA.push(sb + character + sc)
				} else {
					// ToDo: can we reduce any false positives: check a different style?
					displayA.push(character)
				}
				//console.log(w +" x "+ h)
			}
			// track total tofu
			countTofu += tofuCount
			// remainder
			if (charsB.length > 0) {
				//displayA.push(sg + "&#x25C0" + sc) // show test marker
				displayB = charsB
			}
			// colors
			let percent = (tofuCount/maxDepth) * 100
			let strA = displayA.join(" ")
			if (percent >= 90) {
				anchorColor = "sb"
				nameColor = sb
				if (percent !== 100) {partial = " ["+ tofuCount +"/" + maxDepth +"]"}
				aRed.push("<a class='"+ anchorColor +"' href='#"+ anchor +"'>"+ name +"</a>" + partial)
				if (percent !== 100) {partial = sb + partial + sc}
			} else if (percent >= 20) {
				nameColor = s2
				partial = " ["+ tofuCount +"/" + maxDepth +"]"
				strA = strA.replace(/bad/g, "s2")
				aOrange.push("<a class='s2' href='#"+ anchor +"'>"+ name +"</a>" + partial)
				partial = s2 + partial + sc
			} else if (percent > 0) {
				//anchorColor = "s4" // too noisy, just let the count be colored
				nameColor = s4
				partial = " ["+ tofuCount +"/" + maxDepth +"]"
				strA = strA.replace(/bad/g, "s4")
				aYellow.push("<a class='s4' href='#"+ anchor +"'>"+ name +"</a>" + partial)
				partial = s4 + partial + sc
			}
			// display
			aLegend.push("<li><a class='"+ anchorColor +"' href='#"+ anchor +"'>"+ name +"</a>" + partial +"</li>")
			aVisual.push(build_title("script", name, anchor, "", nameColor, grouptitle))
			aVisual.push(strA + " " + displayB.join(" ") +"<br>")
			// reset grouptitle
			grouptitle = ""
		}
	})
	// reset slot so we don't end up with unwanted scrollbars
	slot.textContent = ""
	// display visuals
	aVisual.push("<br><a name='end'></a>")
	dom.visual.innerHTML = aVisual.join("<br>")

	// summary
	if (aRed.length) {
		aRed.sort()
		aSummary.push("<br>"+ sb + "unsupported [" + aRed.length +"]"+ sc +"<br>")
		aSummary.push("<br>"+ aRed.join("<br>") +"<br>")
	}
	if (aOrange.length) {
		aOrange.sort()
		aSummary.push("<br>"+ s2 + "mixed [" + aOrange.length +"]"+ sc +"<br>")
		aSummary.push("<br>" + aOrange.join("<br>") +"<br>")
	}
	if (aYellow.length) {
		aYellow.sort()
		aSummary.push("<br>"+ s4 + "partial [" + aYellow.length +"]"+ sc +"<br>")
		aSummary.push("<br>"+ aYellow.join("<br>"))
	}

	// output
	let summaryBtn = " <span class='btn12 btnfirst onClick='copysummary()'>[ copy ]</span>"
	// ToDo: store summary in friendly format
	// and instead directly set content in navigator.clipboard.writeText(content)
	// also output to console

	dom.legend.innerHTML = s12 +"SCRIPTS ["+ countScript +"]" + sc
		//+ " <a class='blue' href='#summary'>#SUMMARY</a>"
		+ "<br>"+ aLegend.join("")
		+ "<br><span id='summary'></span>"+ s12 +"SUMMARY" + sc //+ summaryBtn
		+ "<br><span id='copy'>"+ aSummary.join(" ") +"</span>"

	// perf
	dom.perf.innerHTML = Math.round(performance.now() - t0) +" ms | "
		+ countTested +" chars" +" | "+ countTofu +" tofu"
	isRunning = false
}

//dom.allassigned.checked = true
let isRunning = true
Promise.all([
	get_tofu_size(),
	generate(),
]).then(function(){
	reset(false) // false: leave the generate perf value there
})


</script>
</body>
</html>
