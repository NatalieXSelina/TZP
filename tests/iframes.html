<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=800">
  <title>iframes ua</title>
  <link rel="stylesheet" type="text/css" href="testindex.css">
  <script src="testglobals.js"></script>
  <script src="testgeneric.js"></script>
	<script src="testmain.js"></script>
	<!-- custom -->
	<style>
		table {width: 780px;}
	</style>
</head>
<body>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb2">
		<col width="12%"><col width="88%">
		<thead><tr><th colspan="2">iframes ua</th></tr></thead>
		<tr><td>document</td><td class="mono spaces" id="doc"></td></tr>
		<tr><td>document root</td><td class="mono spaces" id="iframe0"></td></tr>
		<tr><td>with URL</td><td class="mono spaces" id="iframe1"></td></tr>
		<tr><td>violating SOP</td><td class="mono spaces" id="iframe2"></td></tr>
		<tr><td>access 1</td><td class="mono spaces" id="iframe3"></td></tr>
		<tr><td>access 2</td><td class="mono spaces" id="iframe4"></td></tr>
		<tr><td>access 3</td><td class="mono spaces" id="iframe5"></td></tr>
	</table>
	<br>

<script>
'use strict';

var control = ""
s12 = s12.trim()

function getUA() {
	let list = ['userAgent','appCodeName','appName','product','appVersion',
		'oscpu','platform','buildID','productSub','vendor','vendorSub',],
		res = [],
		r = ""
	for(let i=0; i < list.length; i++) {
		try {r = navigator[list[i]]} catch(e) {r = (e.name == zB0)}
		if (r == "") {r = 'empty string'}
		if (r == "undefined") {r = "undefined string"}
		if (r == undefined) {r = "undefined value"}
		res.push(list[i]+":"+r)
	}
	res.sort()
	control = sha1(res.join())
	let pretty = []
	for (let i = 0; i < res.length; i++) {
		let parts = res[i].split(":")
		let prop = parts[0].padStart(12)
		let value = parts.slice(1).join(":")
		pretty.push(s12 + prop + sc +": "+ value)
	}
	dom.doc.innerHTML = sg + control + sc
	 + "<br>" + pretty.join("<br>")
}

	getUA()
	

	Promise.all([
		getDynamicIframeWindow({
			context: window,
			violateSameOriginPolicy: false,
			test: "ua"
		}), // DocumentRoot
		getDynamicIframeWindow({
			context: window,
			source: "?",
			violateSameOriginPolicy: false,
			test: "ua"
		}), // with URL
		getDynamicIframeWindow({
			context: window,
			source: "//example.org",
			test: "ua"
		}), // violating SOP
		getDynamicIframeWindow({
			context: window,
			test: "ua"
		}), // access 1
		getDynamicIframeWindow({
			context: frames,
			test: "ua"
		}), // access 2
		getDynamicIframeWindow({
			context: window,
			nestIframeInContainerDiv: true,
			test: "ua"
		}), // access 3
	]).then(function(results){

		for(let i=0; i < 6; i++) {
			let el = document.getElementById("iframe"+i)
			let testhash = sha1(results[i])
			let isMatch = (testhash == control)
			testhash = (testhash == control ? sg.trim() : sb.trim()) + testhash + sc
			if (isMatch) {
				el.innerHTML = testhash
			} else {
				let pretty = []
				let res = results[i]
				for (let i = 0; i < res.length; i++) {
					let parts = res[i].split(":")
					let prop = parts[0].padStart(12)
					let value = parts.slice(1).join(":")
					pretty.push(s12 + prop + sc +": "+ value)
				}
				el.innerHTML = testhash + "<br>" + pretty.join("<br>")
			}
		}
	})

function getDynamicIframeWindow({
	context,
	source = "",
	test = "",
	nestIframeInContainerDiv = false,
	violateSameOriginPolicy = true,
	display = false
}) {
	const elementName = nestIframeInContainerDiv ? 'div' : 'iframe'
	const length = context.length
	const element = document.createElement(elementName)
	document.body.appendChild(element)
	if (!display) {
		element.setAttribute('style', 'display:none')
	}
	if (nestIframeInContainerDiv) {
	const attributes = `
		${source ? `src=${source}` : ''}
			${violateSameOriginPolicy ? '' : `sandbox="allow-same-origin"`}
		`
		element.innerHTML = `<iframe ${attributes}></iframe>`
	} else if (!violateSameOriginPolicy) {
		element.setAttribute('sandbox', 'allow-same-origin')
		if (source) {
			element.setAttribute('src', source)
		}
	} else if (source) {
		element.setAttribute('src', source)
	}
	const iframeWindow = context[length]

	let res = []
	let navigator = iframeWindow.navigator

	if (test == "ua") {
		let list = ['userAgent','appCodeName','appName','product','appVersion',
			'oscpu','platform','buildID','productSub','vendor','vendorSub'],
			r = ""
		for (let i=0; i < list.length; i++) {
			try {r = navigator[list[i]]} catch(e) {r = zB0}
			if (r == "") {r = "empty string"}
			if (r == "undefined") {r = "undefined string"}
			if (r == undefined) {r = "undefined value"}
			res.push(list[i]+":"+r)
		}
		res.sort()
	}
	document.body.removeChild(element)
	return res
}


</script>
</body>
</html>
