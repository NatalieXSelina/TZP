<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=600">
	<title>domrect spoof detection</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 580px;}
		hr {color: #c18cdc}
		#rectTest {
			background-color: skyblue;
			top: 0;
			left: 0;
			width:100px;
			height:100px;
			transform: rotate(45deg);
			padding: 0px;
			/* opacity: 0; */
			z-index: -20;
			position: fixed; /* must be fixed */
		}
	</style>
</head>
<body>
	<div id="rectTest"></div>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb15">
		<col width="15%"><col width="25%"><col width="60%">
		<thead><tr><th colspan="3">
			<div class="nav-title">domrect spoof detection
				<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="3" class="intro">
			<span class="no_color">Gecko only. Measures a fixed element, rotated to forced decimal precision,
			for an expected known result at any zoom level (try it: it auto-runs on resize) and on any platform.
			</span>
		</td></tr>

		<tr><td colspan="3"><hr></td></tr>
		<tr><td colspan="2">expected</td><td class="mono spaces" id="expected"></td></tr>
		<tr><td colspan="3"></td></tr>

		<tr><td colspan="3"><hr></td></tr>
		<tr><td colspan="2">Element.getBoundingClientRect</td><td class="mono" id="res0"></td></tr>
		<tr><td colspan="2">Element.getClientRects</td><td class="mono" id="res1"></td></tr>
		<tr><td colspan="2">range.getBoundingClientRect</td><td class="mono" id="res2"></td></tr>
		<tr><td colspan="2">range.getClientRects</td><td class="mono" id="res3"></td></tr>
		<tr><td colspan="3"></td></tr>

		<tr><td colspan="3"><hr></td></tr>
		<tr><td>history</td><td colspan="2" class="mono spaces" id="history"></td></tr>

	</table>
	<br>

<script>
'use strict';

let aHistory = []
let expected = [
	"ee1ba407",
	"     x: -20.716659545898438",
	"     y: -20.716659545898438",
	" width: 141.41665649414062",
	"height: 141.41665649414062",
	"   top: -20.716659545898438",
	"  left: -20.716659545898438",
	" right: 120.69999694824219",
	"bottom: 120.69999694824219",
]
let count = 0
dom.expected.innerHTML = expected.join("<br>")

let sNames = ["Element.getBoundingClientRect", "Element.getClientRects",
	"Range.getBoundingClientRect", "Range.getClientRects"]


function get_rect() {
	if (aHistory.length > 19) {aHistory = aHistory.slice(-19)}
	// clear details
	sNames.forEach(function(name) {sDetail[name] = []})

	let valid = "ee1ba407"
	let el = dom.rectTest
	let res = []
	for (let i=0; i < 4; i++) {
		try {
			let obj = ""
			let output = document.getElementById("res"+i)
			if (i == 0) {
				obj = el.getBoundingClientRect()
			} else if (i == 1) {
				obj = el.getClientRects()[0]
			} else {
				let range = document.createRange()
				range.selectNode(el)
				if (i == 2) {
					obj = range.getBoundingClientRect()
				} else {
					obj = range.getClientRects()[0]
				}
			}
			// 3 unique values, but cover all names
			let array = [obj.x, obj.y, obj.width, obj.height, obj.top, obj.left, obj.right, obj.bottom]
			sDetail[sNames[i]] = array
			let hash = mini(array.join())
			let display = hash + (hash == valid ? green_tick : red_cross)
			if (hash !== valid) {
				display += buildButton("15", sNames[i], "details")
			}
			output.innerHTML = display
			res.push(hash + (mini(array.join()) == valid ? green_tick : red_cross))
		} catch(e) {
			output.innerHTML = e.name
			res.push(zErr)
		}
	}
	// add to history
	count++
	aHistory.push((count.toString()).padStart(3)+ ": " + res.join(" | "))
	dom.history.innerHTML = aHistory.join("<br>")


}

window.addEventListener("resize", get_rect)
get_rect()

</script>
</body>
</html>
