<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=1024">
  <title>textmetrics noise</title>
<style>
body {background-color: #1a1a1a; color: #b3b3b3;}
.offscreen {position: absolute; top: -2000%;}
.orange {color: #dca78c;}
.good {color: #8cdc8c;}
.bad {color: #ff4f4f;}
.mono {font-family: monospace, "Courier New"; font-size: 13px;}
.spaces {white-space: pre;}
</style>
</head>
<body>
<div class="offscreen">
	<div><canvas id="ugCanvas" style='font-size: 22pt;'></canvas></div>
</div>

<br>
<div class="mono spaces"><span id="stats"></span><b><span class="orange" id="perf"></span></b></div>
<br>
<div class="orange">width</div>
<div class="mono spaces" id="tm00"></div>
<br><hr>
<div class="orange">actualBoundingBoxAscent</div>
<div class="mono spaces" id="tm01"></div>
<br>
<div class="orange">actualBoundingBoxDescent</div>
<div class="mono spaces" id="tm02"></div>
<br>
<div class="orange">actualBoundingBoxLeft</div>
<div class="mono spaces" id="tm03"></div>
<br>
<div class="orange">actualBoundingBoxRight</div>
<div class="mono spaces" id="tm04"></div>

<br><hr>
<div class="orange">emHeightAscent</div>
<div class="mono spaces" id="tm06"></div>
<br>
<div class="orange">emHeightDescent</div>
<div class="mono spaces" id="tm07"></div>

<br><hr>
<div class="orange">fontBoundingBoxAscent</div>
<div class="mono spaces" id="tm08"></div>
<br>
<div class="orange">fontBoundingBoxDescent</div>
<div class="mono spaces" id="tm09"></div>

<br><hr>
<div class="orange">alphabeticBaseline</div>
<div class="mono spaces" id="tm05"></div>
<br>
<div class="orange">hangingBaseline</div>
<div class="mono spaces" id="tm10"></div>
<br>
<div class="orange">ideographicBaseline</div>
<div class="mono spaces" id="tm11"></div>

<script>

var s0 = "<span class='",
	sb = s0+"bad'>",
	sg = s0+"good'>",
	sc = "</span>"

var list1 = [	'a','b','c','d','e','f','g','h','i','j','k','l','m',
	'n','o','p','q','r','s','t','u','v','w','x','y','z',
	'A','B','C','D','E','F','G','H','I','J','K','L','M',
	'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
	'1','2','3','4','5','6','7','8','9','0',
	'~','!','@','#','$','%','^','&','*','(',')','-','=','+',]

var list2 =['\u20B9','\u2581','\u20BA','\uA73D','\uFFFD','\u20B8','\u05C6',
	'\u1E9E','\u097F','\uF003','\u1CDA','\u17DD','\u23AE','\u0D02','\u0B82','\u115A',
	'\u2425','\u302E','\uA830','\u2B06','\u21E4','\u20BD','\u2C7B','\u20B0','\uFBEE',
	'\uF810','\uFFFF','\u007F','\u10A0','\u1D790','\u0700','\u1950','\u3095','\u532D',
	'\u061C','\u20E3','\uFFF9','\u0218','\u058F','\u08E4','\u09B3','\u1C50','\u2619',
	'a','b','c','d','e','f','g','h','i','j','k','l','m',
	'n','o','p','q','r','s','t','u','v','w','x','y','z',
	'A','B','C','D','E','F','G','H','I','J','K','L','M',
	'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
	'1','2','3','4','5','6','7','8','9','0',
	'~','!','@','#','$','%','^','&','*','(',')','-','=','+',
	]

var list3 =['\u20B9','\u2581','\u20BA','\uA73D','\uFFFD','\u20B8','\u05C6',
	'\u1E9E','\u097F','\uF003','\u1CDA','\u17DD','\u23AE','\u0D02','\u0B82','\u115A',
	'\u2425','\u302E','\uA830','\u2B06','\u21E4','\u20BD','\u2C7B','\u20B0','\uFBEE',
	'\uF810','\uFFFF','\u007F','\u10A0','\u1D790','\u0700','\u1950','\u3095','\u532D',
	'\u061C','\u20E3','\uFFF9','\u0218','\u058F','\u08E4','\u09B3','\u1C50','\u2619',
	]

function count_decimals(value) {
	if(Math.floor(value) === value) return 0
	return value.toString().split(".")[1].length || 0
}

function measure(list) {
	function supported(property) {
		return TextMetrics.prototype.hasOwnProperty(property)
	}

	let t0 = performance.now()
	let	canvas = document.getElementById("ugCanvas"),
		ctx = canvas.getContext("2d"),
		go = false
	try {
		ctx.font = "normal normal 22000px none"
		go = true
	} catch(e) {}

	if (go) {
		let control = "", test = "", c = "", output = ""
		// results
		let tm00 = [], tm01 = [], tm02 = [], tm03 = [], tm04 = [], tm05 = [],
			tm06 = [], tm07 = [], tm08 = [], tm09 = [], tm10 = [], tm11 = []
		// integer counts
		let tm00c = 0, tm01c = 0, tm02c = 0, tm03c = 0, tm04c = 0, tm05c = 0,
			tm06c = 0, tm07c = 0, tm08c = 0, tm09c = 0, tm10c = 0, tm11c = 0
		// exceeds 13 deimcal places
		let tm00e = 0, tm01e = 0, tm02e = 0, tm03e = 0, tm04e = 0, tm05e = 0,
			tm06e = 0, tm07e = 0, tm08e = 0, tm09e = 0, tm10e = 0, tm11e = 0

		// supported
		let tm00s = supported("width"),
			tm01s = supported("actualBoundingBoxAscent"),
			tm02s = supported("actualBoundingBoxDescent"),
			tm03s = supported("actualBoundingBoxLeft"),
			tm04s = supported("actualBoundingBoxRight"),
			tm05s = supported("alphabeticBaseline"),
			tm06s = supported("emHeightAscent"),
			tm07s = supported("emHeightDescent"),
			tm08s = supported("fontBoundingBoxAscent"),
			tm09s = supported("fontBoundingBoxDescent"),
			tm10s = supported("hangingBaseline"),
			tm11s = supported("ideographicBaseline")
		// blocked
		let tm01b = false, tm02b = false, tm03b = false, tm04b = false,
			tm05b = false, tm06b = false, tm07b = false, tm08b = false,
			tm09b = false, tm10b = false, tm11b = false
		let zNS = "not suported", zB = "api is blocked"

		let debug = []

		// build
		for (let i=0; i < list.length; i++) {
			c = list[i]

			if (tm00s) {
				control = ctx.measureText(c).width
				if (control == undefined) {
					tm00s = false
				} else {
					test = ctx.measureText(c+c).width
					output = (i.toString()).padStart(3) + ": " + (control.toString()).padEnd(20) + " " + (test.toString()).padEnd(20) + " " + c
					if (test !== (control*2)) {tm00.push(output)}
					if (Number.isInteger(control)) {tm00c++}
					if (count_decimals(test) > 13) {tm00e++}
				}
			}

			if (tm01s) {
				z = ctx.measureText(c).actualBoundingBoxAscent
				if (tm01b == false) {
					if (z == undefined) {
						tm01b = true
					} else if (Number.isInteger(z)) {
							tm01c++
					} else {
						output = (i.toString()).padStart(3) + ": " + (z.toString()).padEnd(20) + " " + c
						if (z % 0.0078125 !== 0) {tm01.push(output)}
						if (count_decimals(z) > 13) {tm01e++}
					}
				}
			}

			if (tm02s) {
				z = ctx.measureText(c).actualBoundingBoxDescent
				if (tm02b == false) {
					if (z == undefined) {
						tm02b = true
					} else if (Number.isInteger(z)) {
							tm02c++
					} else {
						output = (i.toString()).padStart(3) + ": " + (z.toString()).padEnd(20) + " " + c
						if (z % 0.0078125 !== 0) {tm02.push(output)}
						if (count_decimals(z) > 13) {tm02e++}
					}
				}
			}

			if (tm03s) {
				z = ctx.measureText(c).actualBoundingBoxLeft
				if (tm03b == false) {
					if (z == undefined) {
						tm03b = true
					} else if (Number.isInteger(z)) {
							tm03c++
					} else {
						output = (i.toString()).padStart(3) + ": " + (z.toString()).padEnd(20) + " " + c
						if (z % 0.0078125 !== 0) {tm03.push(output)}
						if (count_decimals(z) > 13) {tm03e++}
					}
				}
			}

			if (tm04s) {
				z = ctx.measureText(c).actualBoundingBoxRight
				if (tm04b == false) {
					if (z == undefined) {
						tm04b = true
					} else if (Number.isInteger(z)) {
							tm04c++
					} else {
						output = (i.toString()).padStart(3) + ": " + (z.toString()).padEnd(20) + " " + c
						if (z % 0.0078125 !== 0) {tm04.push(output)}
						if (count_decimals(z) > 13) {tm04e++}
					}
				}
			}

			if (tm06s) {
				// all 119 chars are 1609.0293453724605 (13 decimal places)
				z = ctx.measureText(c).emHeightAscent
				if (tm06b == false) {
					if (z == undefined) {
						tm06b = true
					} else if (Number.isInteger(z)) {
							tm06c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm06e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm07s) {
				// a11 119 chars are -390.9706546275395 (13 decimal places)
				z = ctx.measureText(c).emHeightDescent
				if (tm07b == false) {
					if (z == undefined) {
						tm07b = true
					} else if (Number.isInteger(z)) {
							tm07c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm07e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm08s) {
				// all 119 chars are 1782
				z = ctx.measureText(c).fontBoundingBoxAscent
				if (tm08b == false) {
					if (z == undefined) {
						tm08b = true
					} else if (Number.isInteger(z)) {
							tm08c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm08e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm09s) {
				// all 119 chars are 43
				z = ctx.measureText(c).fontBoundingBoxDescent
				if (tm09b == false) {
					if (z == undefined) {
						tm09b = true
					} else if (Number.isInteger(z)) {
							tm09c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm09e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm05s) {
				// all 119 chars are 0
				z = ctx.measureText(c).alphabeticBaseline
				if (tm05b == false) {
					if (z == undefined) {
						tm05b = true
					} else if (Number.isInteger(z)) {
							tm05c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm05e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm10s) {
				// all 119 chars are 1287.2234762979685 (13 decimal places)
				z = ctx.measureText(c).hangingBaseline
				if (tm10b == false) {
					if (z == undefined) {
						tm10b = true
					} else if (Number.isInteger(z)) {
							tm10c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm10e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}

			if (tm11s) {
				// all 119 chars are -195.48532731376974 (14 decimal places)

				z = ctx.measureText(c).ideographicBaseline
				if (tm11b == false) {
					if (z == undefined) {
						tm11b = true
					} else if (Number.isInteger(z)) {
							tm11c++
							//debug.push(i+ ": " + z)
					} else {
						if (count_decimals(z) > 13) {tm11e++}
						//debug.push(i+ ": " + z + " ("+ count_decimals(z) + ")")
					}
				}
			}


		}

		//console.debug(debug.join("\n"))

		// output
		document.getElementById("stats").innerHTML = list.length + " chars"
		let n128 = " non-128ths, "+sc,
			nDec = " decimal places > 13, "+sc
			nInt = " integers<br>" + "---<br>"
		// width
		if (tm00s) {output = sg + tm00.length + " non-matches, " + sc + sb + tm00e + nDec + tm00c + nInt + tm00.join("<br>")} else {output = zB}
			document.getElementById("tm00").innerHTML = output
		// actualBounding
		if (tm01s) {output = (tm01b ? zB : sg + tm01.length + n128 + sb + tm01e + nDec + tm01c + nInt + tm01.join("<br>"))} else {output = zNS}
			document.getElementById("tm01").innerHTML = output
		if (tm02s) {output = (tm02b ? zB : sg + tm02.length + n128 + sb + tm02e + nDec + tm02c + nInt + tm02.join("<br>"))} else {output = zNS}
			document.getElementById("tm02").innerHTML = output
		if (tm03s) {output = (tm03b ? zB : sg + tm03.length + n128 + sb + tm03e + nDec + tm03c + nInt + tm03.join("<br>"))} else {output = zNS}
			document.getElementById("tm03").innerHTML = output
		if (tm04s) {output = (tm04b ? zB : sg + tm04.length + n128 + sb + tm04e + nDec + tm04c + nInt + tm04.join("<br>"))} else {output = zNS}
			document.getElementById("tm04").innerHTML = output
		// emHeight
		if (tm06s) {output = (tm06b ? zB : "supported: test to come: " + sb+ tm06e + nDec + tm06c + nInt)} else {output = zNS}
			document.getElementById("tm06").innerHTML = output
		if (tm07s) {output = (tm07b ? zB : "supported: test to come: " + sb+ tm07e + nDec + tm07c + nInt)} else {output = zNS}
			document.getElementById("tm07").innerHTML = output
		// fontBoundingBox
		if (tm08s) {output = (tm08b ? zB : "supported: test to come: " + sb+ tm08e + nDec + tm08c + nInt)} else {output = zNS}
			document.getElementById("tm08").innerHTML = output
		if (tm09s) {output = (tm09b ? zB : "supported: test to come: " + sb+ tm09e + nDec + tm09c + nInt)} else {output = zNS}
			document.getElementById("tm09").innerHTML = output
		// Baseline
		if (tm05s) {output = (tm05b ? zB : "supported: test to come: " + sb+ tm05e + nDec + tm05c + nInt)} else {output = zNS}
			document.getElementById("tm05").innerHTML = output
		if (tm10s) {output = (tm10b ? zB : "supported: test to come: " + sb+ tm10e + nDec + tm10c + nInt)} else {output = zNS}
			document.getElementById("tm10").innerHTML = output
		if (tm11s) {output = (tm11b ? zB : "supported: test to come: " + sb+ tm11e + nDec + tm11c + nInt)} else {output = zNS}
			document.getElementById("tm11").innerHTML = output


		// perf
		document.getElementById("perf").innerHTML = " (" + (performance.now()-t0) + "ms)"
	} else {
		document.getElementById("stats").innerHTML = sb + "canvas is blocked" + sc
	}

}

measure(list3)


</script>
</body>
</html>
