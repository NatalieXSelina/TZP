<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=400">
	<title>navigator objects</title>
  <link rel="stylesheet" type="text/css" href="testindex.css">
  <script src="testglobals.js"></script>
  <script src="testgeneric.js"></script>
	<script src="testmain.js"></script>
	<!-- custom -->
	<style>
		table {width: 380px;}
	</style>
</head>

<body>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb18">
		<col width="1%"></a><col width="99%">
		<thead><tr><th colspan="2">navigator objects</th></tr></thead>
		<tr><td colspan="2" class="intro"><span class="no_color">
			trueKeys should be found, fakeKeys should be not found<span></span>
		</td></tr>
		<tr><td></td><td class="c mono spaces" id="output"></td></tr>
	</table>

	<br>

<script>
'use strict';

var trueKeys = [],
	fakeKeys = [],
	sColor = s18.trim()

function check_navObject(property) {
	// this fails: sendBeacon + cycec for example
	return !!Object.getOwnPropertyDescriptor(Navigator.prototype, property)
}

function compare() {
	let output = []

	if (trueKeys.length > 0) {
		// remove constructor & sort (easier to read)
		trueKeys.splice(trueKeys.indexOf("constructor"), 1)[0]
		trueKeys.sort()
		output.push(sColor+"trueKeys"+sc+"<br>")
		for (let i = 0; i < trueKeys.length; i++) {
			let property = trueKeys[i]
			let check = check_navObject(property)
			let match = (check ? sg +"found" +sc : sb +"not found" +sc)
			output.push(
				property.padStart(30) +": "+ match
			)
		}
	}
	if (fakeKeys.length > 0) {
		fakeKeys.sort()
		output.push("<br>"+sColor+"fakeKeys"+sc+"<br>")
		for (let i = 0; i < fakeKeys.length; i++) {
			let property = fakeKeys[i]
			let check = check_navObject(property)
			let match = (check ? sb+ "found" +sc : sg +"not found" +sc)
			output.push(
				property.padStart(30) +": "+ match
			)
		}
	}

	// display
	dom.output.innerHTML = output.join("<br>")
}

function get_nav_prototype() {
	return new Promise(resolve => {
		try {
			let keys = Object.keys(Object.getOwnPropertyDescriptors(Navigator.prototype))
			trueKeys = keys
			let lastKeyIndex = keys.length
			fakeKeys = []

			if (isFF) {
				// FF: constructor is always last
				lastKeyIndex = keys.indexOf("constructor")
				trueKeys = keys.slice(0, lastKeyIndex+1)
				fakeKeys = keys.slice(lastKeyIndex+1)
			} else if (isEngine == "blink") {
				// chromium last key is inconsistent
				// split knownPoison from trueKeys into fakeKeys
				let knownPoison = ["SharedWorker", "Worker", "buildID", "getVRDisplays", "activeVRDisplays", "oscpu"]
				trueKeys = keys.filter(x => !knownPoison.includes(x))
				fakeKeys = keys.filter(x => knownPoison.includes(x))
			}

			// add test data
			trueKeys.push("fake-added-for-this-test")
			fakeKeys.push("alsofake-just-for-this-test")

			return resolve("done")
		} catch(e) {
			return resolve(e.name + ": " + e.message)
		}
	})
}

function run() {
	// reset (if I add a rerun button)
	trueKeys = []
	fakeKeys = []
	// get list
	Promise.all([
		get_nav_prototype(),
	]).then(function(result){
		if (result == "done") {
			compare()
		} else {
			dom.output = result
		}
	})
}

run()

</script>

</body>
</html>
